{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Frequently Asked Questions</h2>
    </div>
    
    <!-- Search Bar -->
    <div class="faq-search">
        <input type="text" id="faq-search" placeholder="üîç Search FAQ..." class="search-input">
        <button onclick="clearSearch()" class="btn btn-sm btn-secondary" style="margin-left: 0.5rem;">Clear</button>
    </div>
    
    <!-- Quick Links -->
    <div class="faq-quick-links">
        <button onclick="expandAll()" class="btn btn-sm btn-primary">Expand All</button>
        <button onclick="collapseAll()" class="btn btn-sm btn-secondary">Collapse All</button>
    </div>
    
    <div class="faq-container">
        
        <div class="faq-section">
            <h3 class="faq-section-title" onclick="toggleSection(this)">
                <span class="toggle-icon">‚ñ∂</span> General
            </h3>
            <div class="faq-section-content">
            
            <div class="faq-item">
                <h4>What miners are supported?</h4>
                <p>The platform supports:</p>
                <ul>
                    <li><strong>Avalon Nano 3/3S</strong> - via cgminer TCP API (port 4028)</li>
                    <li><strong>Bitaxe 601</strong> - via REST API</li>
                    <li><strong>NerdQaxe++</strong> - via REST API</li>
                    <li><strong>NMMiner ESP32</strong> - via UDP telemetry broadcasts (port 12345)</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>How do I add a new miner?</h4>
                <p>Navigate to <strong>Miners ‚Üí Add Miner</strong>, select the miner type, enter the IP address, and configure any type-specific settings. The system will automatically detect available modes and capabilities.</p>
            </div>

            <div class="faq-item">
                <h4>Can I switch mining modes remotely?</h4>
                <p>Yes! For Avalon Nano (low/med/high), Bitaxe (eco/standard/turbo/oc), and NerdQaxe++ miners, you can change operating modes from the miner detail page. NMMiner ESP32 devices have limited remote configuration.</p>
            </div>
            </div>
        </div>

        <div class="faq-section">
            <h3 class="faq-section-title" onclick="toggleSection(this)">
                <span class="toggle-icon">‚ñ∂</span> Pool Management
            </h3>
            <div class="faq-section-content">
            
            <div class="faq-item">
                <h4>How do I set up logical pools?</h4>
                <p>Go to <strong>Pools ‚Üí Add Pool</strong> and create your pool configurations. Each pool needs a URL, port, username (wallet address), and password. You can then assign these pools to miners individually.</p>
            </div>

            <div class="faq-item">
                <h4>What's the difference between logical pools and physical pool slots?</h4>
                <p>Logical pools are stored in the system and can be assigned to any miner. Physical pools are the actual pool configurations stored on the miner hardware (e.g., Avalon has 3 slots, NMMiner has 2). The system maps your logical pools to these physical slots when applying configurations.</p>
            </div>

            <div class="faq-item">
                <h4>How does pool health monitoring work?</h4>
                <p>The system checks each enabled pool every 5 minutes by:</p>
                <ul>
                    <li><strong>Connectivity Test</strong> - TCP connection to pool URL/port with 5-second timeout</li>
                    <li><strong>Response Time</strong> - Measures connection latency in milliseconds</li>
                    <li><strong>Reject Rate</strong> - Calculates percentage of rejected shares from all miners using this pool</li>
                </ul>
                <p>Each pool receives a <strong>Health Score</strong> (0-100) based on: <strong>Reachability (40pts)</strong>, <strong>Response Time (30pts)</strong> &lt;50ms=30pts, 50-150ms=20pts, 150-300ms=10pts, &gt;300ms=0pts, and <strong>Reject Rate (30pts)</strong> &lt;1%=30pts, 1-3%=20pts, 3-5%=10pts, &gt;5%=0pts. Recent failures apply -10pt penalties.</p>
            </div>

            <div class="faq-item">
                <h4>What is intelligent pool failover?</h4>
                <p>Intelligent failover automatically switches miners to healthier pools when problems are detected. The system triggers failover when:</p>
                <ul>
                    <li>Pool is <strong>unreachable</strong> for 2+ consecutive checks (10+ minutes)</li>
                    <li>Pool <strong>health score &lt;30</strong> for 3+ consecutive checks (15+ minutes)</li>
                    <li>Pool <strong>reject rate &gt;10%</strong> for 3+ consecutive checks</li>
                </ul>
                <p>When triggered, the system finds the best alternative pool by scoring all other enabled pools (health_score - failures*5), requiring health &gt;70 and current reachability. If a suitable pool is found, the miner automatically switches with event logging.</p>
            </div>

            <div class="faq-item">
                <h4>How do I enable/disable automatic failover?</h4>
                <p>Go to <strong>Pools ‚Üí Pool Health</strong> and use the toggle switch. Automatic failover is <strong>enabled by default</strong>. When disabled, you can still trigger manual failovers from the Pool Health page or miner detail pages. Health monitoring continues even when failover is disabled.</p>
            </div>
            </div>
        </div>

        <div class="faq-section">
            <h3 class="faq-section-title" onclick="toggleSection(this)">
                <span class="toggle-icon">‚ñ∂</span> Automation Rules
            </h3>
            <div class="faq-section-content">
            
            <div class="faq-item">
                <h4>How do automation rules work?</h4>
                <p>Rules evaluate every 60 seconds and trigger actions when conditions are met. You can create rules based on energy pricing, time windows, miner status, or pool failures.</p>
            </div>

            <div class="faq-item">
                <h4>Can I duplicate an existing rule?</h4>
                <p>Yes! Click the <strong>Duplicate</strong> button next to any rule. The copy will open in edit mode with "(Copy)" appended to the name, and will be disabled by default so you can adjust it before enabling.</p>
            </div>

            <div class="faq-item">
                <h4>What automation triggers are available?</h4>
                <p>Currently supported triggers:</p>
                <ul>
                    <li><strong>Price threshold</strong> - when energy price goes above/below a value</li>
                    <li><strong>Time window</strong> - during specific hours</li>
                    <li><strong>Miner status</strong> - when a miner goes offline or overheats</li>
                    <li><strong>Pool failure</strong> - when pool becomes unreachable</li>
                </ul>
            </div>
        </div>

        <div class="faq-section">
            <h3>Energy Pricing (Octopus Agile)</h3>
            
            <div class="faq-item">
                <h4>Do I need an Octopus Agile API key?</h4>
                <p>No! The system uses the public Octopus Agile tariff API which doesn't require authentication. Just select your region (A-P) in Settings ‚Üí Energy Pricing.</p>
            </div>

            <div class="faq-item">
                <h4>How often are energy prices updated?</h4>
                <p>Prices are fetched every 30 minutes automatically. The system retrieves the next 48 hours of pricing data when available (usually published by 4pm each day).</p>
            </div>

            <div class="faq-item">
                <h4>Can I automate miners based on electricity price?</h4>
                <p>Absolutely! Create an automation rule with a price threshold trigger. For example: "Turn off miners when price exceeds 20p/kWh" or "Switch to low power mode during expensive periods".</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Pool Integrations</h3>
            
            <div class="faq-item">
                <h4>What is Solopool integration?</h4>
                <p>The system can display statistics from <strong>solopool.org</strong> for Bitcoin (BTC), Bitcoin Cash (BCH), and DigiByte (DGB) solo mining. It shows current round luck, workers online, recent blocks, and total paid amounts with GBP conversions.</p>
            </div>

            <div class="faq-item">
                <h4>How do I enable Braiins Pool stats?</h4>
                <p>Go to <strong>Settings ‚Üí Braiins Pool</strong>, enable the integration, and enter your API token (available from your Braiins Pool account settings). The dashboard will then display your workers, hashrate, and rewards.</p>
            </div>

            <div class="faq-item">
                <h4>Do pool integrations require my miners to be managed here?</h4>
                <p>No! The pool statistics are fetched directly from the pool APIs using your wallet address or API token. Your miners can be mining to these pools from anywhere.</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Cryptocurrency Prices</h3>
            
            <div class="faq-item">
                <h4>Where do the GBP price conversions come from?</h4>
                <p>The system uses a multi-API fallback strategy, trying <strong>CoinGecko</strong> first, then <strong>CoinCap</strong>, then <strong>Binance</strong>. This ensures prices are available even if one API is rate-limited or offline.</p>
            </div>

            <div class="faq-item">
                <h4>How often are crypto prices updated?</h4>
                <p>Prices are cached and updated every <strong>10 minutes</strong> to avoid rate limits. The colored dot next to each price indicates freshness:</p>
                <ul>
                    <li><strong>Green <span style="color: #28a745;">‚óè</span></strong> - Fresh data (under 30 minutes old)</li>
                    <li><strong>Amber <span style="color: #ffc107;">‚óè</span></strong> - Aging data (30 mins - 2 hours)</li>
                    <li><strong>Red <span style="color: #dc3545;">‚óè</span></strong> - Stale data (over 2 hours old)</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>Why don't I see GBP conversions?</h4>
                <p>If conversions aren't showing, check the <strong>Logs</strong> page for API errors. The system will log any failures from CoinGecko, CoinCap, or Binance. Cache indicators will turn red if prices haven't updated in over 2 hours.</p>
            </div>

            <div class="faq-item">
                <h4>What's the price ticker in the header?</h4>
                <p>The top-right corner displays current prices for all active coins (BTC, BCH, DGB) with cache age indicators. It refreshes every 30 seconds and is hidden on mobile devices to save space.</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Telemetry & Monitoring</h3>
            
            <div class="faq-item">
                <h4>How often is telemetry collected?</h4>
                <p>Standard miners (Avalon, Bitaxe, NerdQaxe++) are polled every <strong>30 seconds</strong>. NMMiner ESP32 devices broadcast their telemetry autonomously via UDP every few seconds.</p>
            </div>

            <div class="faq-item">
                <h4>How long is telemetry data stored?</h4>
                <p>Telemetry older than <strong>48 hours</strong> is automatically purged to keep the database lean. The purge task runs every 6 hours.</p>
            </div>

            <div class="faq-item">
                <h4>What do the log event colors mean?</h4>
                <p>Event badges use color coding:</p>
                <ul>
                    <li><strong>Red</strong> - Errors (connection failures, API errors)</li>
                    <li><strong>Amber</strong> - Warnings (rate limits, timeouts)</li>
                    <li><strong>Blue</strong> - Informational events</li>
                    <li><strong>Green</strong> - Success/normal operations</li>
                </ul>
            </div>
        </div>

        <div class="faq-section">
            <h3>NMMiner ESP32 Specifics</h3>
            
            <div class="faq-item">
                <h4>How does NMMiner configuration work?</h4>
                <p>NMMiner uses UDP broadcasts for both telemetry (port 12345) and configuration (port 12347). To update pool settings, the system sends a JSON config packet to all devices or a specific IP.</p>
            </div>

            <div class="faq-item">
                <h4>Can I configure multiple NMMiner devices at once?</h4>
                <p>Yes! Using IP address <strong>0.0.0.0</strong> sends the configuration to all NMMiner devices on the network simultaneously.</p>
            </div>

            <div class="faq-item">
                <h4>Why can't I change NMMiner power settings?</h4>
                <p>NMMiner ESP32 devices don't expose power metrics or tuning controls via their UDP protocol. They're "lottery miners" optimized for low power consumption and don't support mode switching like other miner types.</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Docker & Configuration</h3>
            
            <div class="faq-item">
                <h4>Where is my data stored?</h4>
                <p>All persistent data lives in the <strong>/config</strong> volume mount:</p>
                <ul>
                    <li><strong>config.yaml</strong> - Application settings</li>
                    <li><strong>data.db</strong> - SQLite database (miners, pools, telemetry, events)</li>
                    <li><strong>logs/</strong> - Application log files</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>What environment variables are supported?</h4>
                <p>The container accepts:</p>
                <ul>
                    <li><strong>WEB_PORT</strong> - HTTP port (default: 8080)</li>
                    <li><strong>TZ</strong> - Timezone (e.g., Europe/London)</li>
                    <li><strong>PUID/PGID</strong> - User/group ID for file permissions</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>How do I backup my configuration?</h4>
                <p>Simply backup the <strong>/config</strong> directory. The data.db file contains all your miners, pools, automation rules, and historical telemetry.</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Energy Optimization</h3>
            
            <div class="faq-item">
                <h4>What are the price thresholds and why were they chosen?</h4>
                <p>The system uses a <strong>15p/kWh default threshold</strong> for auto-optimization decisions, based on UK electricity pricing patterns:</p>
                <ul>
                    <li><strong>Off-Peak (5-12p)</strong> - Typically 11pm-7am, windiest periods, cheapest rates</li>
                    <li><strong>Normal (12-18p)</strong> - Mid-day and evening shoulder periods</li>
                    <li><strong>Peak (20-35p+)</strong> - 4-7pm weekdays, highest demand, most expensive</li>
                </ul>
                <p>For small ASIC miners (100-600W), mining becomes unprofitable above 20-25p/kWh due to energy costs exceeding potential rewards. The 15p threshold is a middle ground that:</p>
                <ul>
                    <li>Catches expensive periods (>15p) before they become deeply unprofitable</li>
                    <li>Allows mining during moderate pricing (10-15p) when still marginally profitable</li>
                    <li>Maximizes mining time during genuinely cheap periods (<10p)</li>
                </ul>
                <p>The visual color coding uses different thresholds for awareness:</p>
                <ul>
                    <li><strong>Green (<10p)</strong> - Definitely mine, excellent profitability</li>
                    <li><strong>Amber (10-25p)</strong> - Profitable but watch closely</li>
                    <li><strong>Red (>25p)</strong> - Barely profitable, consider stopping</li>
                </ul>
                <p><em>You can customize the action threshold (default 15p) in Energy Optimization settings to match your strategy.</em></p>
            </div>

            <div class="faq-item">
                <h4>What's the difference between Auto-Optimization and Automation Rules?</h4>
                <p><strong>Auto-Optimization</strong> is a simple, hands-off feature that checks energy prices every 30 minutes and automatically switches miner modes (high power when cheap, low power when expensive). It's designed for simplicity with a single configurable threshold.</p>
                <p><strong>Automation Rules</strong> are more advanced and flexible, allowing complex conditions (time windows, miner status, pool failures) and multiple actions (mode changes, pool switching, notifications). You can create sophisticated strategies with multiple rules.</p>
                <p><strong>Important:</strong> To prevent conflicts, you cannot enable Auto-Optimization if you have any enabled automation rules with price-based triggers. The system will warn you and require disabling those rules first.</p>
            </div>

            <div class="faq-item">
                <h4>How does auto-optimization decide when to switch modes?</h4>
                <p>Every 30 minutes, the system:</p>
                <ol>
                    <li>Fetches the current Octopus Agile price for your region</li>
                    <li>Compares it to your configured threshold (default 15p/kWh)</li>
                    <li>If price is <strong>below threshold</strong>: Switches to high power mode (Avalon high, Bitaxe turbo, NerdQaxe turbo)</li>
                    <li>If price is <strong>above threshold</strong>: Switches to low power mode (Avalon low, Bitaxe eco, NerdQaxe eco)</li>
                    <li>Only applies changes if the miner is not already in the target mode</li>
                </ol>
                <p>The system logs each mode change with the price context so you can track behavior.</p>
            </div>

            <div class="faq-item">
                <h4>Can I use auto-optimization with NMMiner devices?</h4>
                <p>No. NMMiner ESP32 devices are "lottery miners" with fixed low power consumption and no mode switching capabilities. Auto-optimization only works with Avalon Nano, Bitaxe, and NerdQaxe++ miners that support different power modes.</p>
            </div>
        </div>

        <div class="faq-section">
            <h3>Troubleshooting</h3>
            
            <div class="faq-item">
                <h4>A miner shows as offline but it's running</h4>
                <p>Check:</p>
                <ul>
                    <li>IP address is correct and reachable from the Docker container</li>
                    <li>Miner's API is enabled (cgminer API for Avalon, web interface for Bitaxe/NerdQaxe)</li>
                    <li>No firewall blocking the connection</li>
                    <li>For NMMiner: UDP broadcasts are on the same network segment</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>Automation rules aren't triggering</h4>
                <p>Verify:</p>
                <ul>
                    <li>Rule is <strong>enabled</strong></li>
                    <li>Trigger conditions are correctly configured (check price thresholds, time formats)</li>
                    <li>Target miners/pools exist and are valid</li>
                    <li>Check Logs page for rule evaluation errors</li>
                </ul>
            </div>

            <div class="faq-item">
                <h4>Dashboard tiles not showing</h4>
                <p>If pool integration tiles are missing:</p>
                <ul>
                    <li>Ensure integration is enabled in Settings</li>
                    <li>Verify API tokens/credentials are correct</li>
                    <li>Check at least one miner is using pools from that provider</li>
                    <li>Review Logs for API connection errors</li>
                </ul>
            </div>
        </div>

    </div>
</div>

<style>
.faq-container {
    padding: 2rem;
}

.faq-section {
    margin-bottom: 3rem;
}

.faq-section h3 {
    color: var(--accent);
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border);
}

.faq-item {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--bg-tertiary);
    border-radius: 8px;
    border-left: 3px solid var(--accent);
}

.faq-item h4 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
}

.faq-item p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 0.5rem;
}

.faq-item ul {
    margin-left: 1.5rem;
    margin-top: 0.5rem;
    color: var(--text-secondary);
}

.faq-item ul li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.faq-item strong {
    color: var(--text-primary);
}

@media (max-width: 768px) {
    .faq-container {
        padding: 1rem;
    }
    
    .faq-item {
        padding: 1rem;
    }
    
    .faq-section h3 {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}
