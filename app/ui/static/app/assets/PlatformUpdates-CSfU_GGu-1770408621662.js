import{c as E,r as n,j as e,R as y,w as b}from"./index-CyEDCHEM-1770408621662.js";import{A as m}from"./alert-triangle-DyZr2OLH-1770408621662.js";import{I as _}from"./info-Dv6TQe4I-1770408621662.js";import{D as L}from"./download-BPIHiDXt-1770408621662.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=E("ExternalLink",[["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}],["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["line",{x1:"10",x2:"21",y1:"14",y2:"3",key:"18c3s4"}]]),B=()=>{const[c,I]=n.useState(null),[a,U]=n.useState(null),[N,D]=n.useState([]),[r,o]=n.useState(null),[l,x]=n.useState({status:"unknown",service:"",timestamp:null,error:null}),[h,i]=n.useState(!0),[P,p]=n.useState(!1),[u,v]=n.useState(null),w=async()=>{try{const s=await fetch("/api/updates/container");if(s.ok){const t=await s.json();I(t)}}catch(s){console.error("Failed to fetch container info:",s)}},g=async()=>{try{const s=await fetch("/api/updates/check");if(s.ok){const t=await s.json();U(t)}}catch(s){console.error("Failed to fetch version info:",s)}},j=async()=>{try{const s=await fetch("/api/updates/changelog");if(s.ok){const t=await s.json();D(t)}}catch(s){console.error("Failed to fetch changelog:",s)}},S=async()=>{try{const s=await fetch("/api/updates/updater-health");if(s.ok){const t=await s.json();x({status:"healthy",service:t.service||"hmm-local-updater",timestamp:t.timestamp,error:null})}else{const t=await s.json();x({status:"unhealthy",service:"hmm-local-updater",timestamp:null,error:t.detail||"Connection failed"})}}catch(s){x({status:"unhealthy",service:"hmm-local-updater",timestamp:null,error:s instanceof Error?s.message:"Connection failed"})}},k=async()=>{try{const s=await fetch("/api/updates/status");if(s.ok){const t=await s.json();if(o(t),t.status==="restarting"||t.status==="success"||t.progress>=60&&t.message.includes("restart"))return T(),!1;if(t.status!=="idle"&&t.status!=="completed"&&t.status!=="error")return!0;if(t.status==="completed"||t.status==="error")return setTimeout(()=>{w(),g(),j()},2e3),!1}return!1}catch(s){return console.error("Failed to fetch update status:",s),!1}},T=()=>{o(d=>d?{...d,status:"starting",message:"Container restarting... Page will refresh when ready.",progress:80}:null);let s=0;const t=30,C=setInterval(async()=>{s++;try{(await fetch("/api/updates/check")).ok&&(clearInterval(C),o({status:"completed",message:"Update completed! Refreshing page...",progress:100,error:null}),setTimeout(()=>{window.location.reload()},1e3))}catch{s>=t&&(clearInterval(C),o({status:"error",message:"Container restart taking longer than expected. Please refresh manually.",progress:90,error:"Timeout waiting for container"}))}},1e3)},F=()=>{if(u)return;const s=setInterval(async()=>{await k()||(clearInterval(s),v(null))},2e3);v(s)};n.useEffect(()=>((async()=>{i(!0),await Promise.all([w(),g(),j(),k(),S()]),i(!1)})(),()=>{u&&clearInterval(u)}),[]);const H=async()=>{i(!0),await Promise.all([g(),j()]),i(!1)},R=async()=>{try{const s=await fetch("/api/updates/apply",{method:"POST",headers:{"Content-Type":"application/json"}});if(s.ok)p(!1),F();else{const t=await s.json();alert(`Update failed: ${t.detail}`)}}catch(s){console.error("Failed to start update:",s),alert("Failed to start update")}},f=s=>s?new Date(s).toLocaleString("en-GB",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Unknown",A=s=>{switch(s){case"completed":return"text-green-400";case"error":return"text-red-400";case"checking":case"pulling":case"stopping":case"starting":return"text-yellow-400";default:return"text-gray-400"}},V=s=>{switch(s){case"completed":return e.jsx(b,{className:"w-5 h-5"});case"error":return e.jsx(m,{className:"w-5 h-5"});default:return e.jsx(y,{className:"w-5 h-5 animate-spin"})}};return h&&!a?e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:e.jsx(y,{className:"w-8 h-8 text-purple-500 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-gray-100",children:[e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Platform Updates"}),e.jsx("p",{className:"text-gray-400",children:"Manage system updates from GitHub Container Registry"}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${l.status==="healthy"?"bg-green-900 bg-opacity-30 text-green-400 border border-green-600":l.status==="unhealthy"?"bg-red-900 bg-opacity-30 text-red-400 border border-red-600":"bg-gray-800 text-gray-400 border border-gray-600"}`,children:[l.status==="healthy"&&e.jsx(b,{className:"w-4 h-4"}),l.status==="unhealthy"&&e.jsx(m,{className:"w-4 h-4"}),l.status==="unknown"&&e.jsx(_,{className:"w-4 h-4"}),e.jsxs("span",{children:[l.status==="healthy"&&"Updater Connected",l.status==="unhealthy"&&"Updater Disconnected",l.status==="unknown"&&"Checking updater..."]})]}),l.error&&e.jsxs("span",{className:"text-xs text-red-400",children:["(",l.error,")"]})]})]}),e.jsxs("button",{onClick:H,disabled:h||(r==null?void 0:r.status)!=="idle",className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg transition-colors",children:[e.jsx(y,{className:`w-4 h-4 ${h?"animate-spin":""}`}),"Refresh"]})]}),r&&r.error&&r.error.includes("docker.sock")&&e.jsxs("div",{className:"bg-yellow-900 bg-opacity-30 border-2 border-yellow-600 rounded-lg p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2 text-yellow-400",children:[e.jsx(m,{className:"w-5 h-5"}),"Docker Socket Not Mounted"]}),e.jsx("p",{className:"text-gray-300 mb-4",children:"Platform Updates requires access to the Docker socket. Add this to your deployment:"}),e.jsxs("div",{className:"bg-gray-900 rounded p-4 font-mono text-sm overflow-x-auto",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:"# For docker run:"}),e.jsx("div",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock"}),e.jsx("div",{className:"mt-4 text-gray-400 mb-2",children:"# Complete example:"}),e.jsxs("div",{className:"text-gray-300",children:["docker run -d \\",e.jsx("br",{}),"  --name hmm-local \\",e.jsx("br",{}),"  --network bridge \\",e.jsx("br",{}),"  -p 8080:8080 \\",e.jsx("br",{}),"  -v /data/hmm-local:/config \\",e.jsx("br",{}),"  ",e.jsx("span",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock \\"}),e.jsx("br",{}),"  --restart unless-stopped \\",e.jsx("br",{}),"  ghcr.io/renegadeuk/hmm-local:latest"]})]}),e.jsx("p",{className:"text-yellow-200 text-sm mt-4",children:"⚠️ After adding the Docker socket, restart your container for Platform Updates to work."})]}),c&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-purple-500"}),"Container Information"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Container Name:"}),e.jsx("span",{className:"ml-2 font-mono",children:c.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Image:"}),e.jsx("span",{className:"ml-2 font-mono",children:c.image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Network:"}),e.jsx("span",{className:"ml-2 font-mono",children:c.network_mode})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"IP Address:"}),e.jsx("span",{className:"ml-2 font-mono",children:c.ip_address})]})]})]}),r&&r.status!=="idle"&&e.jsxs("div",{className:`bg-gray-800 rounded-lg p-6 mb-6 border-2 ${r.status==="completed"?"border-green-600":r.status==="error"?"border-red-600":"border-yellow-600"}`,children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:A(r.status),children:V(r.status)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold capitalize",children:r.status}),e.jsx("p",{className:"text-gray-400",children:r.message}),r.error&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:r.error})]}),e.jsxs("div",{className:"text-2xl font-bold",children:[r.progress,"%"]})]}),r.status!=="completed"&&r.status!=="error"&&e.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${r.progress}%`}})})]}),a&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Version Information"}),a.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-yellow-600 text-white rounded-full text-sm font-semibold",children:["Update Available (",a.commits_behind," commits behind)"]}),!a.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-green-600 text-white rounded-full text-sm font-semibold flex items-center gap-1",children:[e.jsx(b,{className:"w-4 h-4"}),"Up to Date"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-400 mb-3",children:"Current Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:a.current_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:a.current_tag})]}),a.current_commit&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:a.current_commit.substring(0,7)})]}),a.current_message&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:a.current_message})]}),a.current_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:f(a.current_date)})]})]})]})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border-2 border-purple-600",children:[e.jsx("h3",{className:"text-lg font-semibold text-purple-400 mb-3",children:"Latest Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:a.latest_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:a.latest_tag})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:a.latest_commit.substring(0,7)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:a.latest_message})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:f(a.latest_date)})]})]})]})]}),a.update_available&&(r==null?void 0:r.status)==="idle"&&e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:()=>p(!0),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:[e.jsx(L,{className:"w-5 h-5"}),"Update to ",a.latest_tag]})})]}),N.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Recent Commits"}),e.jsx("div",{className:"space-y-3",children:N.slice(0,10).map(s=>e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 hover:bg-gray-850 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold mb-1",children:s.message}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400",children:[e.jsx("span",{className:"font-mono",children:s.sha_short}),e.jsx("span",{children:s.author}),e.jsx("span",{children:f(s.date)})]})]}),e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"text-purple-500 hover:text-purple-400 transition-colors",title:"View on GitHub",children:e.jsx(M,{className:"w-5 h-5"})})]})},s.sha))})]})]}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(m,{className:"w-6 h-6 text-yellow-500"}),"Confirm Update"]}),e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsx("p",{className:"text-gray-300",children:"This will update the system to the latest version from GitHub Container Registry."}),e.jsxs("div",{className:"bg-gray-900 rounded p-3 space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"From:"})," ",e.jsx("span",{className:"font-mono",children:a==null?void 0:a.current_tag})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"To:"})," ",e.jsx("span",{className:"font-mono text-purple-400",children:a==null?void 0:a.latest_tag})]})]}),e.jsx("div",{className:"bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-3",children:e.jsx("p",{className:"text-yellow-200 text-sm",children:"⚠️ The container will restart during the update. Your network settings and configuration will be preserved."})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>p(!1),className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:R,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:"Confirm Update"})]})]})})]})};export{B as default};
