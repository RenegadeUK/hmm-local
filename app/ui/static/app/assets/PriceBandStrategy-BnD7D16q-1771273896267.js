import{m as pe,r as p,a as C,o as se,Y as re,n as T,j as e,C as g,f as x,A as z,B as M,Z as P,d as N,O as Q,t as G,v as J,w as Z,x as Y,y as E,V as X}from"./index-CjS44ej6-1771273896267.js";import{L as xe}from"./layers-sqsULd01-1771273896267.js";import{Z as he}from"./zap-B8URm8lF-1771273896267.js";import{R as D}from"./refresh-ccw-C1XikO-0-1771273896267.js";import{I as ue}from"./info-xSs3p5MR-1771273896267.js";async function b(d,c){const h=await fetch(d,{headers:{"Content-Type":"application/json",...(c==null?void 0:c.headers)||{}},...c});if(!h.ok){const u=await h.json().catch(()=>({})),v=u.detail||u.message||`Request failed (${h.status})`;throw new Error(v)}if(h.status!==204)return h.json()}const k={bitaxe:{label:"Bitaxe 601",icon:he,helper:"Full control (eco/standard/turbo/oc)",order:1},nerdqaxe:{label:"NerdQaxe++",icon:re,helper:"Supports aggressive tuning profiles",order:2},avalon_nano:{label:"Avalon Nano 3/3S",icon:xe,helper:"Uses low / med / high workmodes",order:3},nmminer:{label:"NMMiner ESP32",icon:se,helper:"Lottery miners for extreme variance plays",order:4}};function ge(d){if(!d)return"Never";const c=new Date(d);return`${c.toLocaleDateString()} · ${c.toLocaleTimeString()}`}function be(d){return d==null?"—":`${d.toFixed(2)} p/kWh`}function je(d){return d==="managed_externally"?"HA Off / External":d==="oc"?"OC":d==="med"?"Medium":d.charAt(0).toUpperCase()+d.slice(1)}function ee(d){return d.replace(/[_-]+/g," ").split(" ").filter(Boolean).map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" ")}function we(){var V;const d=pe(),[c,h]=p.useState(new Set),[u,v]=p.useState(!1),[_,q]=p.useState(!1),[A,j]=p.useState(null),{data:r,isLoading:te,error:F}=C({queryKey:["price-band-strategy"],queryFn:()=>b("/api/settings/price-band-strategy")}),{data:O,isLoading:ne,error:L}=C({queryKey:["price-band-strategy-bands"],queryFn:()=>b("/api/settings/price-band-strategy/bands")}),{data:B,isLoading:ae}=C({queryKey:["pools-for-bands"],queryFn:()=>b("/api/pools/for-bands")}),{data:o}=C({queryKey:["price-band-strategy-capabilities"],queryFn:()=>b("/api/settings/price-band-strategy/capabilities")}),le=p.useMemo(()=>{var t;const s=(o==null?void 0:o.miner_types)??{},n={};for(const[l,i]of Object.entries(s)){if(!((t=i.available_modes)!=null&&t.length))continue;const a=i.available_modes.includes("managed_externally")?i.available_modes:["managed_externally",...i.available_modes];n[l]=a.map(m=>({value:m,label:je(m)}))}return n},[o]),w=p.useMemo(()=>{const s=(o==null?void 0:o.miner_types)??{};return Object.entries(s).filter(([,t])=>{var l;return!!((l=t.available_modes)!=null&&l.length)}).map(([t,l])=>{var i;return{minerType:t,field:t,label:l.display_name||((i=k[t])==null?void 0:i.label)||ee(t)}}).sort((t,l)=>{var m,S;const i=((m=k[t.minerType])==null?void 0:m.order)??999,a=((S=k[l.minerType])==null?void 0:S.order)??999;return i!==a?i-a:t.label.localeCompare(l.label)})},[o]),ie=p.useMemo(()=>Object.keys((r==null?void 0:r.miners_by_type)??{}).map(n=>{var l,i;const t=k[n];return{key:n,label:((i=(l=o==null?void 0:o.miner_types)==null?void 0:l[n])==null?void 0:i.display_name)||(t==null?void 0:t.label)||ee(n),icon:(t==null?void 0:t.icon)||se,helper:(t==null?void 0:t.helper)||"Driver-managed miner type",order:(t==null?void 0:t.order)??999}}).sort((n,t)=>n.order!==t.order?n.order-t.order:n.label.localeCompare(t.label)),[o==null?void 0:o.miner_types,r==null?void 0:r.miners_by_type]);p.useEffect(()=>{r&&(v(r.enabled),q(r.champion_mode_enabled||!1),h(new Set(r.enrolled_miners.map(s=>s.id))))},[r]);const H=T({mutationFn:s=>b("/api/settings/price-band-strategy",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{j({type:"success",message:"Strategy settings saved"}),d.invalidateQueries({queryKey:["price-band-strategy"]})},onError:s=>{j({type:"error",message:s.message})}}),U=T({mutationFn:({bandId:s,body:n})=>b(`/api/settings/price-band-strategy/bands/${s}`,{method:"PATCH",body:JSON.stringify(n)}),onSuccess:()=>{d.invalidateQueries({queryKey:["price-band-strategy-bands"]})},onError:s=>{j({type:"error",message:s.message})}}),K=T({mutationFn:()=>b("/api/settings/price-band-strategy/bands/reset",{method:"POST"}),onSuccess:()=>{j({type:"success",message:"Bands reset to defaults"}),d.invalidateQueries({queryKey:["price-band-strategy-bands"]})},onError:s=>{j({type:"error",message:s.message})}}),f=p.useMemo(()=>({status:u?"Enabled":"Disabled",currentBand:(r==null?void 0:r.current_price_band)||"—",lastAction:ge((r==null?void 0:r.last_action_time)||null),currentPrice:be((r==null?void 0:r.last_price_checked)??null),enrolled:c.size,hysteresis:(r==null?void 0:r.hysteresis_counter)??0}),[r==null?void 0:r.current_price_band,r==null?void 0:r.hysteresis_counter,r==null?void 0:r.last_action_time,r==null?void 0:r.last_price_checked,c.size,u]),de=s=>{h(n=>{const t=new Set(n);return t.has(s)?t.delete(s):t.add(s),t})},ce=(s,n)=>{h(t=>{const l=new Set(t);return s.forEach(i=>{n?l.add(i):l.delete(i)}),l})},oe=()=>{H.mutate({enabled:u,miner_ids:Array.from(c),champion_mode_enabled:_})},R=(s,n,t)=>{const l=t.trim(),i=l===""?null:Number(l);if(i!==null&&Number.isNaN(i)){j({type:"error",message:"Price thresholds must be numeric"});return}U.mutate({bandId:s,body:{[n]:i}})},I=(s,n,t)=>{U.mutate({bandId:s,body:{[n]:t}})};return te?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(D,{className:"h-6 w-6 animate-spin"}),e.jsx("p",{children:"Loading Price Band Strategy…"})]})}):F?e.jsx("div",{className:"p-6",children:e.jsx(g,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(x,{className:"flex items-center gap-3 p-6 text-red-200",children:[e.jsx(z,{className:"h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Unable to load strategy settings"}),e.jsx("p",{className:"text-sm opacity-80",children:F instanceof Error?F.message:"Unknown error"})]})]})})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(re,{className:"h-5 w-5"}),e.jsx("span",{children:"Price Band Strategy"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Energy Price Band Strategy"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Enroll miners, map provider price bands to mining targets, and let HMM orchestrate pool switching, tuning, and Home Assistant device control."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(M,{variant:u?"default":"outline",onClick:()=>v(s=>!s),className:"w-32",children:u?"Enabled":"Enable"}),e.jsx(M,{variant:"outline",disabled:H.isPending,onClick:oe,children:"Save Settings"})]})]}),A&&e.jsx("div",{className:P("rounded-md border px-4 py-3 text-sm",A.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:A.message}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(g,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Status"}),e.jsx("p",{className:P("mt-2 text-xl font-semibold",u?"text-green-300":"text-gray-300"),children:f.status})]})}),e.jsx(g,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Band"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:f.currentBand})]})}),e.jsx(g,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Last Action"}),e.jsx("p",{className:"mt-2 text-sm text-gray-200",children:f.lastAction})]})}),e.jsx(g,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Enrolled Miners"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:f.enrolled})]})})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Strategy Primer"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Understand how pricing bands, solo vs pooled modes, and hysteresis interact before enabling automation."})]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-blue-200",children:[e.jsx(ue,{className:"h-4 w-4"})," What happens when prices spike?"]}),e.jsx("p",{className:"mt-2 text-blue-100/80",children:'When the OFF band threshold is reached the orchestration layer pauses miner tuning/pool changes and sends "off" commands to linked Home Assistant switches. As soon as prices settle into a cheaper band the strategy resumes normal operation.'})]}),e.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 text-sm text-amber-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-amber-200",children:[e.jsx(z,{className:"h-4 w-4"})," Avoid rule conflicts"]}),e.jsx("p",{className:"mt-2 text-amber-100/80",children:"Automation rules that touch enrolled miners (mode changes, pool overrides, HA commands) may conflict with the strategy engine. Disable conflicting rules or scope them to miners not enrolled here."})]})]})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enroll Miners"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Only enabled ASIC miners appear. Use group toggles to speed up selection."})]})}),e.jsx(x,{className:"space-y-6",children:ie.map(s=>{var i;const n=((i=r==null?void 0:r.miners_by_type)==null?void 0:i[s.key])??[],t=n.filter(a=>c.has(a.id)).length,l=n.length>0&&t===n.length;return e.jsxs("div",{className:"rounded-lg border border-gray-800 bg-gray-900/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(s.icon,{className:"h-4 w-4 text-blue-300"})," ",s.label]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.helper})]}),n.length>0&&e.jsxs(M,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>ce(n.map(a=>a.id),!l),children:[l?"Clear":"Select all"," (",t,"/",n.length,")"]})]}),n.length===0?e.jsx("p",{className:"mt-4 rounded-md border border-dashed border-gray-700 p-3 text-sm text-gray-500",children:"No miners available."}):e.jsx("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:n.map(a=>e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border border-gray-800 bg-gray-950/60 p-3 hover:border-blue-500/40",children:[e.jsx(Q,{checked:c.has(a.id),onCheckedChange:()=>de(a.id)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-100",children:a.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID #",a.id]})]})]},a.id))})]},s.key)})})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Price Band Strategy"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Map provider price windows to pool targets and tuning modes."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(M,{variant:"outline",size:"sm",disabled:K.isPending,onClick:()=>K.mutate(),className:"gap-2",children:[e.jsx(D,{className:"h-4 w-4"})," Reset to defaults"]})})]})})}),e.jsx(x,{className:"space-y-4",children:e.jsx("div",{className:"rounded-lg border border-purple-500/30 bg-purple-500/5 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx(Q,{checked:_,onCheckedChange:s=>q(!!s),className:"mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("p",{className:"font-semibold text-purple-200",children:"Enable Champion Mode for Band 5 (20-30 p/kWh)"})}),e.jsx("p",{className:"mt-1 text-sm text-purple-100/70",children:"Only the most efficient miner (by W/TH) runs in lowest mode during expensive periods. All other miners are turned OFF via Home Assistant. Champion is sticky until band exit. If champion fails, next best miner is promoted."}),_&&(r==null?void 0:r.current_champion_miner_id)&&e.jsxs("div",{className:"mt-3 rounded-md border border-purple-400/30 bg-purple-900/20 px-3 py-2",children:[e.jsx("p",{className:"text-xs uppercase text-purple-300",children:"Current Champion"}),e.jsx("p",{className:"mt-1 font-semibold text-purple-100",children:((V=r.enrolled_miners.find(s=>s.id===r.current_champion_miner_id))==null?void 0:V.name)||`Miner #${r.current_champion_miner_id}`})]})]})]})})}),e.jsx(N,{children:e.jsx("p",{className:"text-sm text-gray-400",children:"Configure price bands below. Band 5 uses champion mode when enabled."})}),e.jsx(x,{className:"overflow-x-auto",children:ne?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading bands…"}):L?e.jsx("div",{className:"rounded-md border border-red-500/40 bg-red-500/10 p-4 text-sm text-red-200",children:L.message||"Failed to load price bands"}):e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Price band (p/kWh)"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Coin"}),w.map(s=>e.jsxs("th",{className:"py-3 pr-4 font-medium",children:[s.label," Mode"]},s.minerType)),e.jsx("th",{className:"py-3 font-medium",children:"Notes"})]})}),e.jsx("tbody",{children:O==null?void 0:O.bands.map(s=>{var i;const n=s.target_pool_id===null,l=s.sort_order===5&&_;return e.jsx(p.Fragment,{children:e.jsxs("tr",{className:P("border-t border-gray-800",l&&"bg-purple-500/5"),children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",defaultValue:s.min_price??"",placeholder:"min",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>R(s.id,"min_price",a.target.value)}),e.jsx("span",{className:"text-gray-500",children:"–"}),e.jsx("input",{type:"number",defaultValue:s.max_price??"",placeholder:"max",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>R(s.id,"max_price",a.target.value)})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(G,{value:((i=s.target_pool_id)==null?void 0:i.toString())||"OFF",onValueChange:a=>{const m=a==="OFF"?null:parseInt(a,10);I(s.id,"target_pool_id",m)},children:[e.jsx(J,{children:e.jsx(Z,{placeholder:"Select pool"})}),e.jsxs(Y,{children:[e.jsx(E,{value:"OFF",children:"OFF (devices off)"}),ae?e.jsx(E,{value:"loading",disabled:!0,children:"Loading pools..."}):B==null?void 0:B.map(a=>e.jsxs(E,{value:a.id.toString(),children:[a.name," · ",a.supported_coins.join(", ")]},a.id))]})]})}),l&&w.length>0?e.jsx("td",{className:"py-3 pr-4",colSpan:w.length,children:e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-purple-500/40 bg-purple-900/20 px-3 py-2",children:[e.jsx(X,{className:"h-4 w-4 text-purple-300"}),e.jsx("span",{className:"text-sm font-semibold text-purple-200",children:"Champion Mode Enabled"}),e.jsx("span",{className:"text-xs text-purple-300/70",children:"(Most efficient miner in lowest mode)"})]})}):e.jsx(e.Fragment,{children:w.map(a=>{var W,$;const m=le[a.minerType]??[],S=(W=m[0])==null?void 0:W.value,me=(($=s.mode_targets)==null?void 0:$[a.minerType])??S??"managed_externally";return e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(G,{disabled:n,value:me,onValueChange:y=>I(s.id,"mode_targets",{...s.mode_targets||{},[a.minerType]:y}),children:[e.jsx(J,{children:e.jsx(Z,{placeholder:`${a.label} mode`})}),e.jsx(Y,{children:m.map(y=>e.jsx(E,{value:y.value,children:y.label},y.value))})]})},a.minerType)})}),e.jsx("td",{className:"py-3 text-gray-500",children:n?"Turns off all linked HA devices":l?"Champion promoted on band entry, sticky until exit":"Applies pool + mode changes (or HA off if selected)"})]})},s.id)})})]})})]}),e.jsxs(g,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(X,{className:"h-5 w-5 text-green-300"})," Hysteresis & Recovery"]})}),e.jsx(x,{children:e.jsxs("ul",{className:"list-disc space-y-2 pl-5 text-sm text-gray-300",children:[e.jsx("li",{children:"Upgrades into cheaper bands require the next 30-minute slot to confirm the same or better price."}),e.jsx("li",{children:"Downgrades into expensive bands happen immediately to avoid negative profitability."}),e.jsx("li",{children:"The scheduler executes every 30 minutes plus an additional reconciliation run when prices change suddenly."}),e.jsxs("li",{children:["Current hysteresis counter: ",e.jsx("span",{className:"font-semibold text-white",children:f.hysteresis})]})]})})]})]})}export{we as default};
