import{m as I,r as h,a as v,n as c,j as e,C as S,d as k,e as C,f as T,B as x,R as L,s as Q,t as $,v as H,w as J,x as _}from"./index-BaPAvkb_-1770585399581.js";import{L as m}from"./loader-2-C1HNulHq-1770585399581.js";import{T as B}from"./trash-2-TjIlZmdl-1770585399581.js";import{C as R}from"./check-circle-2-BfOstn0M-1770585399581.js";import{A as W}from"./alert-triangle-DPk6OqtN-1770585399581.js";async function i(r,d){const n=await fetch(r,d);if(!n.ok){const a=await n.json().catch(()=>({detail:n.statusText}));throw new Error(a.detail||n.statusText)}return n.json()}function U({config:r}){return r!=null&&r.configured?r.last_test_success===!0?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-500/15 px-2 py-0.5 text-xs font-medium text-green-300",children:[e.jsx(R,{className:"h-3.5 w-3.5"})," Connected"]}):r.last_test_success===!1?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-red-500/15 px-2 py-0.5 text-xs font-medium text-red-300",children:[e.jsx(W,{className:"h-3.5 w-3.5"})," Connection failed"]}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-amber-500/10 px-2 py-0.5 text-xs text-amber-200",children:"Not tested"}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-slate-500/10 px-2 py-0.5 text-xs text-slate-300",children:"Not configured"})}function Z(){const r=I(),[d,n]=h.useState(null),[a,u]=h.useState({name:"SmartThings",access_token:"",enabled:!0}),[g,F]=h.useState(!1),{data:t,isLoading:P}=v({queryKey:["smartthings-config"],queryFn:()=>i("/api/integrations/smartthings/config"),refetchOnWindowFocus:!1}),{data:p,isLoading:q}=v({queryKey:["smartthings-devices",g],queryFn:()=>i(`/api/integrations/smartthings/devices${g?"":"?enrolled_only=true"}`),enabled:(t==null?void 0:t.configured)===!0,refetchOnWindowFocus:!1}),{data:f}=v({queryKey:["miners"],queryFn:()=>i("/api/miners/"),refetchOnWindowFocus:!1});h.useState(()=>{t!=null&&t.configured&&u({name:t.name||"SmartThings",access_token:"",enabled:t.enabled||!1})});const j=c({mutationFn:async s=>i("/api/integrations/smartthings/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-config"]})},onError:s=>{n({tone:"error",message:s.message})}}),b=c({mutationFn:async()=>i("/api/integrations/smartthings/test",{method:"POST"}),onSuccess:s=>{n({tone:s.success?"success":"error",message:s.message}),r.invalidateQueries({queryKey:["smartthings-config"]})},onError:s=>{n({tone:"error",message:s.message})}}),y=c({mutationFn:async()=>i("/api/integrations/smartthings/config",{method:"DELETE"}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-config"]}),r.invalidateQueries({queryKey:["smartthings-devices"]}),u({name:"SmartThings",access_token:"",enabled:!0})},onError:s=>{n({tone:"error",message:s.message})}}),N=c({mutationFn:async()=>i("/api/integrations/smartthings/discover",{method:"POST"}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-devices"]})},onError:s=>{n({tone:"error",message:s.message})}}),A=c({mutationFn:async({deviceId:s,enrolled:o})=>i(`/api/integrations/smartthings/devices/${s}/enroll`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enrolled:o})}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-devices"]})},onError:s=>{n({tone:"error",message:s.message})}}),E=c({mutationFn:async({deviceId:s,minerId:o})=>i(`/api/integrations/smartthings/devices/${s}/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({miner_id:o})}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-devices"]})},onError:s=>{n({tone:"error",message:s.message})}}),D=c({mutationFn:async({deviceId:s,neverAutoControl:o})=>i(`/api/integrations/smartthings/devices/${s}/safety`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({never_auto_control:o})}),onSuccess:s=>{n({tone:"success",message:s.message}),r.invalidateQueries({queryKey:["smartthings-devices"]})},onError:s=>{n({tone:"error",message:s.message})}}),O=()=>{if(!a.name.trim()){n({tone:"error",message:"Name is required"});return}if(!(t!=null&&t.configured)&&!a.access_token.trim()){n({tone:"error",message:"Personal Access Token is required"});return}j.mutate({name:a.name,access_token:a.access_token||null,enabled:a.enabled})},K=()=>{confirm("Are you sure you want to delete SmartThings configuration and all devices?")&&y.mutate()},M=s=>{switch(s){case"switch":return"ðŸ”Œ";case"light":return"ðŸ’¡";case"dimmer":return"ðŸŽšï¸";case"thermostat":return"ðŸŒ¡ï¸";case"sensor":return"ðŸ“¡";default:return"â“"}};if(P)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center",children:e.jsx(m,{className:"h-8 w-8 animate-spin text-muted-foreground"})});const w=(p==null?void 0:p.devices)||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("nav",{className:"flex text-sm text-muted-foreground",children:[e.jsx("a",{href:"/",className:"hover:text-foreground",children:"Home"}),e.jsx("span",{className:"mx-2",children:"/"}),e.jsx("a",{href:"/settings",className:"hover:text-foreground",children:"Settings"}),e.jsx("span",{className:"mx-2",children:"/"}),e.jsx("span",{className:"text-foreground",children:"SmartThings"})]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"SmartThings Integration"}),e.jsx("p",{className:"mt-2 text-muted-foreground",children:"Control miners via SmartThings devices (bypass Home Assistant)"})]}),e.jsx(U,{config:t})]}),d&&e.jsx("div",{className:`rounded-lg border p-4 ${d.tone==="success"?"border-green-500/50 bg-green-500/10 text-green-300":d.tone==="error"?"border-red-500/50 bg-red-500/10 text-red-300":"border-blue-500/50 bg-blue-500/10 text-blue-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:d.message}),e.jsx("button",{onClick:()=>n(null),className:"hover:opacity-70",children:"Ã—"})]})}),e.jsxs(S,{children:[e.jsx(k,{children:e.jsx(C,{children:"Configuration"})}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"name",className:"text-sm font-medium",children:"Name"}),e.jsx("input",{type:"text",id:"name",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:a.name,onChange:s=>u({...a,name:s.target.value}),placeholder:"SmartThings"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"access_token",className:"text-sm font-medium",children:["Personal Access Token (PAT)",e.jsx("a",{href:"https://account.smartthings.com/tokens",target:"_blank",rel:"noopener noreferrer",className:"ml-2 text-xs text-muted-foreground hover:text-foreground",children:"Get PAT â†’"})]}),e.jsx("input",{type:"password",id:"access_token",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:a.access_token,onChange:s=>u({...a,access_token:s.target.value}),placeholder:t!=null&&t.configured?"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢":"Enter your PAT"}),(t==null?void 0:t.configured)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Leave empty to keep existing token"})]}),e.jsxs("div",{className:"flex items-center space-x-2 sm:col-span-2",children:[e.jsx("input",{type:"checkbox",id:"enabled",className:"h-4 w-4 rounded border-gray-300",checked:a.enabled,onChange:s=>u({...a,enabled:s.target.checked})}),e.jsx("label",{htmlFor:"enabled",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Enable SmartThings integration"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{onClick:O,disabled:j.isPending,children:j.isPending?e.jsxs(e.Fragment,{children:[e.jsx(m,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save Configuration"}),(t==null?void 0:t.configured)&&e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"outline",onClick:()=>b.mutate(),disabled:b.isPending,children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(m,{className:"mr-2 h-4 w-4 animate-spin"}),"Testing..."]}):"Test Connection"}),e.jsx(x,{variant:"destructive",onClick:K,disabled:y.isPending,className:"ml-auto",children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(m,{className:"mr-2 h-4 w-4 animate-spin"}),"Deleting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Delete Configuration"]})})]})]})]})]}),(t==null?void 0:t.configured)&&t.enabled&&e.jsxs(S,{children:[e.jsx(k,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{children:"Devices"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:s=>F(s.target.checked),className:"h-4 w-4 rounded"}),"Show all devices"]}),e.jsx(x,{size:"sm",onClick:()=>N.mutate(),disabled:N.isPending,children:N.isPending?e.jsxs(e.Fragment,{children:[e.jsx(m,{className:"mr-2 h-4 w-4 animate-spin"}),"Discovering..."]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Discover Devices"]})})]})]})}),e.jsx(T,{children:q?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(m,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):w.length===0?e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx("p",{children:"No devices found"}),e.jsx("p",{className:"mt-2 text-sm",children:'Click "Discover Devices" to scan for SmartThings devices'})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border text-left text-sm text-muted-foreground",children:[e.jsx("th",{className:"pb-3 pr-4 font-medium"}),e.jsx("th",{className:"pb-3 pr-4 font-medium",children:"Device Name"}),e.jsx("th",{className:"pb-3 pr-4 font-medium",children:"Type"}),e.jsx("th",{className:"pb-3 pr-4 font-medium",children:"Linked Miner"}),e.jsx("th",{className:"pb-3 pr-4 font-medium",children:"Enrolled"}),e.jsx("th",{className:"pb-3 pr-4 font-medium",children:"Safety Lock"}),e.jsx("th",{className:"pb-3 font-medium",children:"State"})]})}),e.jsx("tbody",{children:w.map(s=>{var o;return e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"py-3 pr-4 text-center text-2xl",children:M(s.domain)}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.device_id})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsx("span",{className:"inline-flex items-center rounded-full bg-secondary px-2 py-0.5 text-xs font-medium",children:s.domain})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(Q,{value:((o=s.miner_id)==null?void 0:o.toString())||"",onValueChange:l=>E.mutate({deviceId:s.id,minerId:l?parseInt(l):null}),children:[e.jsx($,{className:"w-[180px]",children:e.jsx(H,{placeholder:"Not linked"})}),e.jsxs(J,{children:[e.jsx(_,{value:"",children:"Not linked"}),f==null?void 0:f.map(l=>e.jsx(_,{value:l.id.toString(),children:l.name},l.id))]})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsx("input",{type:"checkbox",checked:s.enrolled,disabled:!s.miner_id,onChange:l=>A.mutate({deviceId:s.id,enrolled:l.target.checked}),className:"h-4 w-4 rounded"})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsx("button",{onClick:()=>D.mutate({deviceId:s.id,neverAutoControl:!s.never_auto_control}),className:"text-lg hover:opacity-70",title:s.never_auto_control?"Safety locked":"Not locked",children:s.never_auto_control?"ðŸ”’":"ðŸ”“"})}),e.jsx("td",{className:"py-3",children:s.current_state?e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${s.current_state==="on"?"bg-green-500/15 text-green-300":"bg-secondary text-muted-foreground"}`,children:s.current_state.toUpperCase()}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})})]},s.id)})})]})})})]}),e.jsxs(S,{children:[e.jsx(k,{children:e.jsx(C,{children:"About SmartThings Integration"})}),e.jsxs(T,{className:"space-y-3 text-sm text-muted-foreground",children:[e.jsx("p",{children:"This integration allows HMM to control SmartThings devices directly via the SmartThings API, bypassing Home Assistant for improved performance and reliability."}),e.jsxs("ul",{className:"list-inside list-disc space-y-1",children:[e.jsx("li",{children:"Create a Personal Access Token in your SmartThings account"}),e.jsx("li",{children:"Discover devices connected to your SmartThings hub"}),e.jsx("li",{children:"Link devices to miners for automated control"}),e.jsx("li",{children:"Enable enrollment to allow Agile Solo Strategy to control devices"}),e.jsx("li",{children:"Use safety lock to prevent automation from controlling critical devices"})]})]})]})]})}export{Z as default};
