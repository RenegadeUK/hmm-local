import{l as Y,r as p,a as R,j as e,C as h,f as c,A as U,Q as K,B as v,U as O,d as b,Z as D,m as ee,I as V,p as _,q as S,s as C,t as w,v as B,O as W}from"./index-Cb-8Xm3o.js";import{u as M}from"./useMutation-BVM47t1T.js";import{R as $}from"./refresh-ccw-RFlkwryo.js";import{I as se}from"./info-BUyVw650.js";import{L as ae}from"./layers-MrUUyTsQ.js";const le=[{value:"OFF",label:"OFF (devices off)"},{value:"DGB",label:"DGB · DigiByte Solo"},{value:"BC2",label:"BC2 · DigiByte Turbo"},{value:"BCH",label:"BCH · Bitcoin Cash Solo"},{value:"BTC",label:"BTC · Bitcoin Solo"},{value:"BTC_POOLED",label:"BTC · Braiins Pool"}],F={bitaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],nerdqaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],avalon_nano:[{value:"managed_externally",label:"HA Off / External"},{value:"low",label:"Low"},{value:"med",label:"Medium"},{value:"high",label:"High"}]};async function j(d,n){const o=await fetch(d,{headers:{"Content-Type":"application/json",...(n==null?void 0:n.headers)||{}},...n});if(!o.ok){const m=await o.json().catch(()=>({})),f=m.detail||m.message||`Request failed (${o.status})`;throw new Error(f)}if(o.status!==204)return o.json()}const re=[{key:"bitaxe",label:"Bitaxe 601",icon:D,helper:"Full control (eco/standard/turbo/oc)"},{key:"nerdqaxe",label:"NerdQaxe++",icon:K,helper:"Supports aggressive tuning profiles"},{key:"avalon_nano",label:"Avalon Nano 3/3S",icon:ae,helper:"Uses low / med / high workmodes"},{key:"nmminer",label:"NMMiner ESP32",icon:ee,helper:"Lottery miners for extreme variance plays"}];function te(d){if(!d)return"Never";const n=new Date(d);return`${n.toLocaleDateString()} · ${n.toLocaleTimeString()}`}function ne(d){return d==null?"—":`${d.toFixed(2)} p/kWh`}function xe(){var Q;const d=Y(),[n,o]=p.useState(new Set),[m,f]=p.useState(!1),[y,T]=p.useState(!1),[A,u]=p.useState(null),{data:a,isLoading:z,error:k}=R({queryKey:["agile-strategy"],queryFn:()=>j("/api/settings/agile-solo-strategy")}),{data:E,isLoading:G,error:H}=R({queryKey:["agile-strategy-bands"],queryFn:()=>j("/api/settings/agile-solo-strategy/bands")});p.useEffect(()=>{a&&(f(a.enabled),T(a.champion_mode_enabled||!1),o(new Set(a.enrolled_miners.map(s=>s.id))))},[a]);const P=M({mutationFn:s=>j("/api/settings/agile-solo-strategy",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{u({type:"success",message:"Strategy settings saved"}),d.invalidateQueries({queryKey:["agile-strategy"]})},onError:s=>{u({type:"error",message:s.message})}}),q=M({mutationFn:({bandId:s,body:r})=>j(`/api/settings/agile-solo-strategy/bands/${s}`,{method:"PATCH",body:JSON.stringify(r)}),onSuccess:()=>{d.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),L=M({mutationFn:()=>j("/api/settings/agile-solo-strategy/bands/reset",{method:"POST"}),onSuccess:()=>{u({type:"success",message:"Bands reset to defaults"}),d.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),g=p.useMemo(()=>({status:m?"Enabled":"Disabled",currentBand:(a==null?void 0:a.current_price_band)||"—",lastAction:te((a==null?void 0:a.last_action_time)||null),currentPrice:ne((a==null?void 0:a.last_price_checked)??null),enrolled:n.size,hysteresis:(a==null?void 0:a.hysteresis_counter)??0}),[a==null?void 0:a.current_price_band,a==null?void 0:a.hysteresis_counter,a==null?void 0:a.last_action_time,a==null?void 0:a.last_price_checked,n.size,m]),J=s=>{o(r=>{const t=new Set(r);return t.has(s)?t.delete(s):t.add(s),t})},Z=(s,r)=>{o(t=>{const i=new Set(t);return s.forEach(l=>{r?i.add(l):i.delete(l)}),i})},X=()=>{P.mutate({enabled:m,miner_ids:Array.from(n),champion_mode_enabled:y})},I=(s,r,t)=>{const i=t.trim(),l=i===""?null:Number(i);if(l!==null&&Number.isNaN(l)){u({type:"error",message:"Price thresholds must be numeric"});return}q.mutate({bandId:s,body:{[r]:l}})},N=(s,r,t)=>{q.mutate({bandId:s,body:{[r]:t}})};return z?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx($,{className:"h-6 w-6 animate-spin"}),e.jsx("p",{children:"Loading Agile Strategy…"})]})}):k?e.jsx("div",{className:"p-6",children:e.jsx(h,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(c,{className:"flex items-center gap-3 p-6 text-red-200",children:[e.jsx(U,{className:"h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Unable to load strategy settings"}),e.jsx("p",{className:"text-sm opacity-80",children:k instanceof Error?k.message:"Unknown error"})]})]})})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(K,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Strategy"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Octopus Agile Solo Strategy"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Enroll miners, map Octopus Agile price bands to mining targets, and let HMM orchestrate pool switching, tuning, and Home Assistant device control."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(v,{variant:m?"default":"outline",onClick:()=>f(s=>!s),className:"w-32",children:m?"Enabled":"Enable"}),e.jsx(v,{variant:"outline",disabled:P.isPending,onClick:X,children:"Save Settings"})]})]}),A&&e.jsx("div",{className:O("rounded-md border px-4 py-3 text-sm",A.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:A.message}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(h,{children:e.jsxs(c,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Status"}),e.jsx("p",{className:O("mt-2 text-xl font-semibold",m?"text-green-300":"text-gray-300"),children:g.status})]})}),e.jsx(h,{children:e.jsxs(c,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Band"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:g.currentBand})]})}),e.jsx(h,{children:e.jsxs(c,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Last Action"}),e.jsx("p",{className:"mt-2 text-sm text-gray-200",children:g.lastAction})]})}),e.jsx(h,{children:e.jsxs(c,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Enrolled Miners"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:g.enrolled})]})})]}),e.jsxs(h,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Strategy Primer"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Understand how pricing bands, solo vs pooled modes, and hysteresis interact before enabling automation."})]})}),e.jsxs(c,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-blue-200",children:[e.jsx(se,{className:"h-4 w-4"})," What happens when prices spike?"]}),e.jsx("p",{className:"mt-2 text-blue-100/80",children:'When the OFF band threshold is reached the orchestration layer pauses miner tuning/pool changes and sends "off" commands to linked Home Assistant switches. As soon as prices settle into a cheaper band the strategy resumes normal operation.'})]}),e.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 text-sm text-amber-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-amber-200",children:[e.jsx(U,{className:"h-4 w-4"})," Avoid rule conflicts"]}),e.jsx("p",{className:"mt-2 text-amber-100/80",children:"Automation rules that touch enrolled miners (mode changes, pool overrides, HA commands) may conflict with the strategy engine. Disable conflicting rules or scope them to miners not enrolled here."})]})]})]}),e.jsxs(h,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enroll Miners"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Only enabled ASIC miners appear. Use group toggles to speed up selection."})]})}),e.jsx(c,{className:"space-y-6",children:re.map(s=>{var l;const r=((l=a==null?void 0:a.miners_by_type)==null?void 0:l[s.key])??[],t=r.filter(x=>n.has(x.id)).length,i=r.length>0&&t===r.length;return e.jsxs("div",{className:"rounded-lg border border-gray-800 bg-gray-900/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(s.icon,{className:"h-4 w-4 text-blue-300"})," ",s.label]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.helper})]}),r.length>0&&e.jsxs(v,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>Z(r.map(x=>x.id),!i),children:[i?"Clear":"Select all"," (",t,"/",r.length,")"]})]}),r.length===0?e.jsx("p",{className:"mt-4 rounded-md border border-dashed border-gray-700 p-3 text-sm text-gray-500",children:"No miners available."}):e.jsx("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:r.map(x=>e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border border-gray-800 bg-gray-950/60 p-3 hover:border-blue-500/40",children:[e.jsx(V,{checked:n.has(x.id),onCheckedChange:()=>J(x.id)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-100",children:x.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID #",x.id]})]})]},x.id))})]},s.key)})})]}),e.jsxs(h,{children:[e.jsx(b,{children:e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Price Band Strategy"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Map Agile price windows to coins and tuning modes."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(v,{variant:"outline",size:"sm",disabled:L.isPending,onClick:()=>L.mutate(),className:"gap-2",children:[e.jsx($,{className:"h-4 w-4"})," Reset to defaults"]})})]})})}),e.jsx(c,{className:"space-y-4",children:e.jsx("div",{className:"rounded-lg border border-purple-500/30 bg-purple-500/5 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx(V,{checked:y,onCheckedChange:s=>T(!!s),className:"mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("p",{className:"font-semibold text-purple-200",children:"Enable Champion Mode for Band 5 (20-30 p/kWh)"})}),e.jsx("p",{className:"mt-1 text-sm text-purple-100/70",children:"Only the most efficient miner (by W/TH) runs in lowest mode during expensive periods. All other miners are turned OFF via Home Assistant. Champion is sticky until band exit. If champion fails, next best miner is promoted."}),y&&(a==null?void 0:a.current_champion_miner_id)&&e.jsxs("div",{className:"mt-3 rounded-md border border-purple-400/30 bg-purple-900/20 px-3 py-2",children:[e.jsx("p",{className:"text-xs uppercase text-purple-300",children:"Current Champion"}),e.jsx("p",{className:"mt-1 font-semibold text-purple-100",children:((Q=a.enrolled_miners.find(s=>s.id===a.current_champion_miner_id))==null?void 0:Q.name)||`Miner #${a.current_champion_miner_id}`})]})]})]})})}),e.jsx(b,{children:e.jsx("p",{className:"text-sm text-gray-400",children:"Configure price bands below. Band 5 uses champion mode when enabled."})}),e.jsx(c,{className:"overflow-x-auto",children:G?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading bands…"}):H?e.jsx("div",{className:"rounded-md border border-red-500/40 bg-red-500/10 p-4 text-sm text-red-200",children:H.message||"Failed to load price bands"}):e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Price band (p/kWh)"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Coin"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Bitaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"NerdQaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Avalon Nano Mode"}),e.jsx("th",{className:"py-3 font-medium",children:"Notes"})]})}),e.jsx("tbody",{children:E==null?void 0:E.bands.map(s=>{const r=s.target_coin==="OFF",i=s.sort_order===5&&y;return e.jsx(p.Fragment,{children:e.jsxs("tr",{className:O("border-t border-gray-800",i&&"bg-purple-500/5"),children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",defaultValue:s.min_price??"",placeholder:"min",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:l=>I(s.id,"min_price",l.target.value)}),e.jsx("span",{className:"text-gray-500",children:"–"}),e.jsx("input",{type:"number",defaultValue:s.max_price??"",placeholder:"max",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:l=>I(s.id,"max_price",l.target.value)})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(_,{value:s.target_coin,onValueChange:l=>N(s.id,"target_coin",l),children:[e.jsx(S,{children:e.jsx(C,{placeholder:"Select coin"})}),e.jsx(w,{children:le.map(l=>e.jsx(B,{value:l.value,children:l.label},l.value))})]})}),i?e.jsx("td",{className:"py-3 pr-4",colSpan:3,children:e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-purple-500/40 bg-purple-900/20 px-3 py-2",children:[e.jsx(W,{className:"h-4 w-4 text-purple-300"}),e.jsx("span",{className:"text-sm font-semibold text-purple-200",children:"Champion Mode Enabled"}),e.jsx("span",{className:"text-xs text-purple-300/70",children:"(Most efficient miner in lowest mode)"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(_,{disabled:r,value:s.bitaxe_mode,onValueChange:l=>N(s.id,"bitaxe_mode",l),children:[e.jsx(S,{children:e.jsx(C,{placeholder:"Bitaxe mode"})}),e.jsx(w,{children:F.bitaxe.map(l=>e.jsx(B,{value:l.value,children:l.label},l.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(_,{disabled:r,value:s.nerdqaxe_mode,onValueChange:l=>N(s.id,"nerdqaxe_mode",l),children:[e.jsx(S,{children:e.jsx(C,{placeholder:"NerdQaxe mode"})}),e.jsx(w,{children:F.nerdqaxe.map(l=>e.jsx(B,{value:l.value,children:l.label},l.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(_,{disabled:r,value:s.avalon_nano_mode,onValueChange:l=>N(s.id,"avalon_nano_mode",l),children:[e.jsx(S,{children:e.jsx(C,{placeholder:"Avalon mode"})}),e.jsx(w,{children:F.avalon_nano.map(l=>e.jsx(B,{value:l.value,children:l.label},l.value))})]})})]}),e.jsx("td",{className:"py-3 text-gray-500",children:r?"Turns off all linked HA devices":i?"Champion promoted on band entry, sticky until exit":"Applies pool + mode changes (or HA off if selected)"})]})},s.id)})})]})})]}),e.jsxs(h,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(W,{className:"h-5 w-5 text-green-300"})," Hysteresis & Recovery"]})}),e.jsx(c,{children:e.jsxs("ul",{className:"list-disc space-y-2 pl-5 text-sm text-gray-300",children:[e.jsx("li",{children:"Upgrades into cheaper bands require the next 30-minute slot to confirm the same or better price."}),e.jsx("li",{children:"Downgrades into expensive bands happen immediately to avoid negative profitability."}),e.jsx("li",{children:"The scheduler executes every 30 minutes plus an additional reconciliation run when prices change suddenly."}),e.jsxs("li",{children:["Current hysteresis counter: ",e.jsx("span",{className:"font-semibold text-white",children:g.hysteresis})]})]})})]})]})}export{xe as default};
