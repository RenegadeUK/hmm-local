import{c as ve,m as be,r as y,a as m,n as b,j as e,Z as w,C as S,d as _,e as k,f as E,t as J,v as H,w as Z,x as Y,y as X,B as v,R as je,_ as Ne,$ as we}from"./index-ClkMrzoI-1771625316237.js";import{P as Se}from"./plug-zap-B3UrcXnT-1771625316237.js";import{A as _e}from"./alert-triangle-aZNlmiWQ-1771625316237.js";import{L as j}from"./loader-2-DjfUPnYg-1771625316237.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=ve("CalendarDays",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]);async function g(r,n){const t=await fetch(r,{headers:{"Content-Type":"application/json",...(n==null?void 0:n.headers)||{}},...n});if(!t.ok){const d=await t.json().catch(()=>({})),l=d.detail||d.message||`Request failed (${t.status})`;throw new Error(l)}if(t.status!==204)return t.json()}const ee=[{value:"A",label:"A - Eastern England"},{value:"B",label:"B - East Midlands"},{value:"C",label:"C - London"},{value:"D",label:"D - Merseyside and Northern Wales"},{value:"E",label:"E - West Midlands"},{value:"F",label:"F - North Eastern England"},{value:"G",label:"G - North Western England"},{value:"H",label:"H - Southern England"},{value:"J",label:"J - South Eastern England"},{value:"K",label:"K - Southern Wales"},{value:"L",label:"L - South Western England"},{value:"M",label:"M - Yorkshire"},{value:"N",label:"N - Southern Scotland"},{value:"P",label:"P - Northern Scotland"}];function Ee(r,n){if(!r||!n)return"—";const t=new Date(r),d=new Date(n);return`${t.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})} → ${d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}`}function qe(r){return r<=0?{background:"linear-gradient(135deg, #60a5fa, #3b82f6)",color:"#ffffff"}:r<10?{background:"linear-gradient(135deg, #10b981, #059669)",color:"#000000"}:r<15?{background:"linear-gradient(135deg, #34d399, #10b981)",color:"#000000"}:r<20?{background:"linear-gradient(135deg, #6ee7b7, #34d399)",color:"#000000"}:r<25?{background:"linear-gradient(135deg, #fbbf24, #f59e0b)",color:"#ffffff"}:r<30?{background:"linear-gradient(135deg, #fb923c, #f97316)",color:"#ffffff"}:{background:"linear-gradient(135deg, #f87171, #ef4444)",color:"#ffffff"}}function Pe({enabled:r}){return r===void 0?e.jsx("span",{className:"rounded-full bg-muted px-3 py-1 text-xs uppercase tracking-wide text-muted-foreground",children:"Loading…"}):e.jsx("span",{className:w("rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide",r?"bg-green-500/10 text-green-300":"bg-slate-700 text-slate-300"),children:r?"Enabled":"Disabled"})}function re({title:r,icon:n,summary:t}){var l;const d=(t==null?void 0:t.price_pence)!==null&&(t==null?void 0:t.price_pence)!==void 0;return e.jsxs(S,{children:[e.jsxs(_,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:r}),e.jsx(k,{className:"text-3xl font-semibold",children:d?`${(l=t==null?void 0:t.price_pence)==null?void 0:l.toFixed(2)} p/kWh`:"No data"})]}),e.jsx(n,{className:"h-10 w-10 text-blue-300"})]}),e.jsx(E,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:d?Ee(t==null?void 0:t.valid_from,t==null?void 0:t.valid_to):"Waiting for latest slot"})})]})}function se({title:r,data:n}){const t=new Date,d=((n==null?void 0:n.prices)||[]).filter(l=>new Date(l.valid_to)>t);return e.jsxs(S,{className:"overflow-hidden",children:[e.jsxs(_,{className:"space-y-1 border-b border-border/50 bg-muted/10",children:[e.jsx("p",{className:"text-xs uppercase tracking-widest text-blue-300",children:r}),e.jsx(k,{className:"text-lg",children:(n==null?void 0:n.date)??"Waiting for pricing data"})]}),e.jsx(E,{className:"p-6",children:d.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"No upcoming half-hour slots yet."}):e.jsx("div",{className:"grid gap-2 md:grid-cols-3 lg:grid-cols-4",children:d.map(l=>{const x=qe(l.price_pence),f=new Date(l.valid_from),a=f.toLocaleDateString("en-GB",{weekday:"short"}),p=f.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"rounded-lg p-3 text-center shadow-sm",style:{background:x.background,color:x.color},children:[e.jsx("p",{className:"text-xs opacity-80",children:`${a} ${p}`}),e.jsxs("p",{className:"text-lg font-semibold",children:[l.price_pence.toFixed(2),"p"]})]},l.valid_from)})})})]})}function Te(){var D,I,B,O,G,R,W,U,A,V,z;const r=be(),[n,t]=y.useState(null),[d,l]=y.useState("octopus_agile"),[x,f]=y.useState("H"),{data:a,isLoading:p,error:te}=m({queryKey:["energy-config"],queryFn:()=>g("/api/dashboard/energy/config"),refetchInterval:6e4}),{data:N=[],error:ae}=m({queryKey:["energy-providers-status"],queryFn:()=>g("/api/drivers/energy-providers/status"),refetchInterval:6e4}),{data:i,error:ne}=m({queryKey:["energy-provider-runtime"],queryFn:()=>g("/api/dashboard/energy/provider-status"),refetchInterval:3e4}),{data:o,error:ie}=m({queryKey:["energy-provider-health",d],queryFn:()=>g(`/api/dashboard/energy/provider-health?provider_id=${d}`),refetchInterval:3e4}),{data:de,error:le}=m({queryKey:["energy-current"],queryFn:()=>g("/api/dashboard/energy/current"),refetchInterval:6e4}),{data:oe,error:ce}=m({queryKey:["energy-next"],queryFn:()=>g("/api/dashboard/energy/next"),refetchInterval:6e4}),{data:u,error:ue}=m({queryKey:["energy-timeline"],queryFn:()=>g("/api/dashboard/energy/timeline"),refetchInterval:6e4});y.useEffect(()=>{a!=null&&a.provider_id&&l(a.provider_id),a!=null&&a.region&&f(a.region)},[a==null?void 0:a.provider_id,a==null?void 0:a.region]);const c=y.useMemo(()=>N.find(s=>s.provider_id===d),[N,d]),q=y.useMemo(()=>{const s=(c==null?void 0:c.supported_regions)||[];return s.length===0?ee:ee.filter(h=>s.includes(h.value))},[c==null?void 0:c.supported_regions]),P=b({mutationFn:s=>g(`/api/dashboard/energy/provider?provider_id=${s}`,{method:"POST"}),onSuccess:(s,h)=>{t({type:"success",message:`Provider switched to ${h}.`}),r.invalidateQueries({queryKey:["energy-config"]}),r.invalidateQueries({queryKey:["energy-provider-runtime"]}),r.invalidateQueries({queryKey:["energy-current"]}),r.invalidateQueries({queryKey:["energy-next"]}),r.invalidateQueries({queryKey:["energy-timeline"]})},onError:s=>t({type:"error",message:s.message})}),C=b({mutationFn:s=>g(`/api/dashboard/energy/region?region=${s}`,{method:"POST"}),onSuccess:(s,h)=>{t({type:"success",message:`Region saved: ${h}. Fetching latest slots…`}),r.invalidateQueries({queryKey:["energy-config"]}),r.invalidateQueries({queryKey:["energy-provider-runtime"]}),r.invalidateQueries({queryKey:["energy-current"]}),r.invalidateQueries({queryKey:["energy-next"]}),r.invalidateQueries({queryKey:["energy-timeline"]})},onError:s=>t({type:"error",message:s.message})}),K=b({mutationFn:s=>g(`/api/dashboard/energy/toggle?enabled=${String(s)}`,{method:"POST"}),onSuccess:(s,h)=>{t({type:"success",message:h?"Energy pricing enabled.":"Energy pricing disabled."}),r.invalidateQueries({queryKey:["energy-config"]})},onError:s=>t({type:"error",message:s.message})}),$=b({mutationFn:s=>g(`/api/drivers/energy-providers/update/${s}`,{method:"POST"}),onSuccess:()=>{t({type:"success",message:"Provider updated successfully."}),r.invalidateQueries({queryKey:["energy-providers-status"]})},onError:s=>t({type:"error",message:s.message})}),Q=[te,ae,ne,ie,le,ce,ue].filter(Boolean),T=C.isPending,L=K.isPending,M=P.isPending,F=$.isPending,ge=x!==(a==null?void 0:a.region),he=d!==(a==null?void 0:a.provider_id),xe=(c==null?void 0:c.status)==="update_available",me=()=>{x&&C.mutate(x)},pe=()=>{d&&P.mutate(d)},ye=()=>{p||a===void 0||K.mutate(!a.enabled)},fe=()=>{c!=null&&c.name&&$.mutate(c.name)};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(Se,{className:"h-5 w-5"}),e.jsx("span",{children:"Energy Pricing"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Energy Provider Pricing"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Select provider, configure provider settings, and monitor synchronization status while keeping the current and upcoming slot views live."})]}),n&&e.jsx("div",{className:w("rounded-md border px-4 py-3 text-sm",n.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:n.message}),Q.length>0&&e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("span",{children:Q.map(s=>s instanceof Error?s.message:"Unable to load energy pricing").join(" • ")})]}),e.jsxs(S,{children:[e.jsxs(_,{className:"flex flex-col gap-4 border-b border-border/50 bg-muted/10 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-widest text-blue-300",children:"Configuration"}),e.jsx(k,{className:"text-xl",children:"Provider Configuration"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Half-hourly prices refresh every 30 minutes."})]}),e.jsx(Pe,{enabled:a==null?void 0:a.enabled})]}),e.jsxs(E,{className:"space-y-6 py-6",children:[e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",htmlFor:"provider-select",children:"Select Provider"}),e.jsxs(J,{value:d,onValueChange:l,children:[e.jsx(H,{id:"provider-select",className:"h-12 text-left",children:e.jsx(Z,{placeholder:"Choose provider"})}),e.jsx(Y,{children:N.map(s=>e.jsxs(X,{value:s.provider_id,children:[s.display_name," (",s.provider_id,")"]},s.provider_id))})]})]}),q.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",htmlFor:"region-select",children:"Select Region"}),e.jsxs(J,{value:x,onValueChange:f,children:[e.jsx(H,{id:"region-select",className:"h-12 text-left",children:e.jsx(Z,{placeholder:"Choose region"})}),e.jsx(Y,{children:q.map(s=>e.jsx(X,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(v,{onClick:pe,disabled:M||!he||p,className:"w-full",children:M?e.jsx(j,{className:"h-4 w-4 animate-spin"}):"Save Provider"}),e.jsx(v,{onClick:me,disabled:T||!ge||p,variant:"secondary",className:"w-full",children:T?e.jsx(j,{className:"h-4 w-4 animate-spin"}):"Save Region"}),e.jsx(v,{onClick:fe,disabled:F||!xe,variant:"outline",className:"w-full",children:F?e.jsx(j,{className:"h-4 w-4 animate-spin"}):"Update Provider"}),e.jsx(v,{onClick:ye,variant:a!=null&&a.enabled?"destructive":"secondary",disabled:L||p,className:"w-full",children:L?e.jsx(j,{className:"h-4 w-4 animate-spin"}):a!=null&&a.enabled?"Disable Pricing":"Enable Pricing"})]}),e.jsxs("div",{className:"rounded-md border border-border/60 bg-muted/20 p-4 text-sm text-muted-foreground space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-foreground",children:"Active:"})," ",((D=i==null?void 0:i.runtime)==null?void 0:D.provider_id)||(i==null?void 0:i.configured_provider_id)||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-foreground",children:"Last Success:"})," ",(I=i==null?void 0:i.runtime)!=null&&I.last_success_at?new Date(i.runtime.last_success_at).toLocaleString("en-GB"):"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-foreground",children:"Last Result:"})," ",(B=i==null?void 0:i.runtime)!=null&&B.last_result?`${i.runtime.last_result.fetched} fetched / ${i.runtime.last_result.inserted} inserted / ${i.runtime.last_result.updated} updated`:"—"]}),((O=i==null?void 0:i.runtime)==null?void 0:O.last_error)&&e.jsxs("div",{className:"text-red-300",children:[e.jsx("span",{className:"font-medium",children:"Last Error:"})," ",i.runtime.last_error]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-foreground",children:"Provider Health:"})," ",e.jsx("span",{className:w(((G=o==null?void 0:o.health)==null?void 0:G.status)==="ok"?"text-green-300":"text-red-300"),children:((R=o==null?void 0:o.health)==null?void 0:R.status)||"unknown"}),(W=o==null?void 0:o.health)!=null&&W.message?` — ${o.health.message}`:""]}),o&&Object.keys(o.validation_errors||{}).length>0&&e.jsxs("div",{className:"text-amber-300",children:[e.jsx("span",{className:"font-medium",children:"Validation:"})," ",Object.entries(o.validation_errors).map(([s,h])=>`${s}: ${h}`).join(" • ")]}),e.jsx("div",{className:"pt-1",children:e.jsxs(v,{onClick:()=>{r.invalidateQueries({queryKey:["energy-provider-runtime"]}),r.invalidateQueries({queryKey:["energy-provider-health"]}),r.invalidateQueries({queryKey:["energy-current"]}),r.invalidateQueries({queryKey:["energy-next"]}),r.invalidateQueries({queryKey:["energy-timeline"]})},size:"sm",variant:"ghost",className:"px-0",children:[e.jsx(je,{className:"mr-2 h-4 w-4"})," Refresh runtime status"]})})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(re,{title:"Current Slot",icon:Ne,summary:de}),e.jsx(re,{title:"Next Slot",icon:we,summary:oe})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(ke,{className:"h-5 w-5"}),e.jsx("span",{children:"Upcoming Timeline"})]}),e.jsx(se,{title:"Today",data:{date:(U=u==null?void 0:u.today)==null?void 0:U.date,prices:(A=u==null?void 0:u.today)==null?void 0:A.prices}}),e.jsx(se,{title:"Tomorrow",data:{date:(V=u==null?void 0:u.tomorrow)==null?void 0:V.date,prices:(z=u==null?void 0:u.tomorrow)==null?void 0:z.prices}})]})]})}export{Te as default};
