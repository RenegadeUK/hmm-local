import{c as q,m as S,r as j,a as p,ak as P,n as y,j as e,al as w,o as F,Z as C,A as M,T as E,y as f}from"./index-tf_IQcZx-1770738519025.js";import{L as c}from"./loader-2-BOP9a1ML-1770738519025.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=q("HardDrive",[["line",{x1:"22",x2:"2",y1:"12",y2:"12",key:"1y58io"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16",key:"sgf278"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16",key:"1l4acy"}]]);function D(){var x,m,h,g,u,b;const N=S(),[l,o]=j.useState(!1),[v,_]=j.useState(!1),{data:s}=p({queryKey:["database-health"],queryFn:async()=>{const t=await fetch("/api/health/database");if(!t.ok)throw new Error("Failed to fetch health");return t.json()},refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),{data:a}=p({queryKey:["migration-status"],queryFn:async()=>{const t=await fetch("/api/settings/database/migrate/status");if(!t.ok)throw new Error("Failed to fetch migration status");return t.json()},enabled:l,refetchInterval:l?1e3:!1});P.useEffect(()=>{a&&!a.running&&a.result&&(window.migrationInterval&&(clearInterval(window.migrationInterval),window.migrationInterval=null),_(!0))},[a]);const r=y({mutationFn:async()=>{const t=await fetch("/api/settings/database/migrate/validate",{method:"POST"});if(!t.ok){const i=await t.json();throw new Error(i.detail)}return t.json()}}),n=y({mutationFn:async({target:t,force:i})=>{const d=await fetch(`/api/settings/database/switch?target=${t}${i?"&force=true":""}`,{method:"POST"});if(!d.ok){const k=await d.json();throw new Error(k.detail)}return d.json()},onSuccess:t=>{t.restart_required?confirm("Database switched! Container restart required. Restart now?")&&fetch("/api/settings/restart",{method:"POST"}):alert(t.message),N.invalidateQueries({queryKey:["database-status"]})},onError:t=>{alert(`Failed to switch: ${t.message}`)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(w,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Database Configuration"})]}),s&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Connection Pool"}),e.jsx(F,{className:`h-4 w-4 ${s.status==="critical"?"text-red-400":s.status==="warning"?"text-yellow-400":"text-green-400"}`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-baseline space-x-2",children:[e.jsxs("span",{className:"text-2xl font-bold text-white",children:[s.pool.utilization_percent,"%"]}),e.jsx("span",{className:"text-sm text-gray-400",children:"utilized"})]}),e.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all ${s.pool.utilization_percent>90?"bg-red-500":s.pool.utilization_percent>80?"bg-yellow-500":"bg-green-500"}`,style:{width:`${s.pool.utilization_percent}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500",children:[s.pool.checked_out,"/",s.pool.total_capacity," connections (",s.pool.max_capacity_configured??s.pool.total_capacity," max)"]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Active Queries"}),e.jsx(C,{className:"h-4 w-4 text-blue-400"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:((x=s.postgresql)==null?void 0:x.active_connections)||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"running queries"}),s.postgresql&&s.postgresql.long_running_queries>0&&e.jsxs("p",{className:"text-xs text-yellow-400 flex items-center space-x-1",children:[e.jsx(M,{className:"h-3 w-3"}),e.jsxs("span",{children:[s.postgresql.long_running_queries," slow (",">","1min)"]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Database Size"}),e.jsx($,{className:"h-4 w-4 text-purple-400"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-2xl font-bold text-white",children:[((m=s.postgresql)==null?void 0:m.database_size_mb.toFixed(1))||"0"," MB"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"total storage"})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Health Status"}),e.jsx(E,{className:`h-4 w-4 ${s.status==="healthy"?"text-green-400":s.status==="warning"?"text-yellow-400":"text-red-400"}`})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${s.status==="healthy"?"bg-green-900/30 text-green-400 border border-green-700":s.status==="warning"?"bg-yellow-900/30 text-yellow-400 border border-yellow-700":"bg-red-900/30 text-red-400 border border-red-700"}`,children:s.status.toUpperCase()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[s.status==="healthy"&&"All systems operational",s.status==="warning"&&"Pool usage high",s.status==="critical"&&"Pool nearly exhausted"]})]})]})]}),(s==null?void 0:s.high_water_marks)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"High-water marks (last 24h)"}),e.jsxs("div",{className:"text-xs text-gray-500 mb-3",children:["Since ",s.high_water_marks.last_24h_date]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Pool in-use peak"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.last_24h.db_pool_in_use_peak})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Active queries peak"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.last_24h.active_queries_peak})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Wait count"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.last_24h.db_pool_wait_count})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Wait seconds"}),e.jsxs("div",{className:"text-white font-semibold",children:[s.high_water_marks.last_24h.db_pool_wait_seconds_sum.toFixed(1),"s"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Slow queries"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.last_24h.slow_query_count})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"High-water marks (since boot)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Pool in-use peak"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.since_boot.db_pool_in_use_peak})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Active queries peak"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.since_boot.active_queries_peak})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Wait count"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.since_boot.db_pool_wait_count})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Wait seconds"}),e.jsxs("div",{className:"text-white font-semibold",children:[s.high_water_marks.since_boot.db_pool_wait_seconds_sum.toFixed(1),"s"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-400",children:"Slow queries"}),e.jsx("div",{className:"text-white font-semibold",children:s.high_water_marks.since_boot.slow_query_count})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Current Database"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"px-4 py-2 rounded-lg font-mono text-lg bg-green-900/30 text-green-400 border border-green-700",children:"POSTGRESQL"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Embedded PostgreSQL running at localhost:5432"})]})]}),!1,l&&a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto border border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Migration Progress"}),e.jsx("div",{className:"space-y-2 mb-4 max-h-96 overflow-y-auto",children:a.progress.map((t,i)=>e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[t.progress===100?e.jsx(f,{className:"h-4 w-4 text-green-400 flex-shrink-0"}):e.jsx(c,{className:"h-4 w-4 animate-spin text-blue-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:t.message})]},i))}),a.result&&e.jsxs("div",{className:`p-4 rounded-md border mb-4 ${a.result.success?"bg-green-900/30 border-green-700":"bg-red-900/30 border-red-700"}`,children:[e.jsx("p",{className:"font-medium",children:a.result.message}),a.result.errors.length>0&&e.jsx("ul",{className:"mt-2 text-sm space-y-1",children:a.result.errors.map((t,i)=>e.jsxs("li",{className:"text-red-400",children:["â€¢ ",t]},i))})]}),v&&((h=a.result)==null?void 0:h.success)&&e.jsxs("div",{className:"mb-4",children:[e.jsx("button",{onClick:()=>r.mutate(),disabled:r.isPending,className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-md font-medium flex items-center justify-center space-x-2",children:r.isPending?e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Validating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Validate Migration"})]})}),r.data&&e.jsxs("div",{className:`mt-3 p-3 rounded-md border ${r.data.success?"bg-green-900/30 border-green-700 text-green-400":"bg-red-900/30 border-red-700 text-red-400"}`,children:[e.jsx("p",{children:r.data.message}),((g=r.data.mismatches)==null?void 0:g.length)>0&&e.jsx("ul",{className:"mt-2 text-sm",children:r.data.mismatches.map((t,i)=>e.jsxs("li",{children:[t.table,": SQLite=",t.sqlite_rows,", PostgreSQL=",t.postgresql_rows]},i))})]})]}),((u=a.result)==null?void 0:u.success)&&((b=r.data)==null?void 0:b.success)&&e.jsx("button",{onClick:()=>{o(!1),n.mutate({target:"postgresql"})},disabled:n.isPending,className:"w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-md font-medium flex items-center justify-center space-x-2",children:n.isPending?e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Switching..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Switch to PostgreSQL"})]})}),!a.running&&e.jsx("button",{onClick:()=>o(!1),className:"w-full mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md font-medium",children:"Close"})]})})]})}export{D as default};
