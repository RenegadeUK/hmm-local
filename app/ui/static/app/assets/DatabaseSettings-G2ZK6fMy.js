import{c as z,l as R,r as x,a as w,ah as Q,j as e,ai as T,m as A,Z as H,A as $,T as K,v,aj as U}from"./index-BJpR5QDc.js";import{u as g}from"./useMutation-CnBjV-GM.js";import{L as d}from"./loader-2-BKtGbMRa.js";import{P as V}from"./play-circle-wrpNGy2S.js";import{S as G}from"./save-D40e5roI.js";import{R as B}from"./refresh-ccw-hzoKMpxC.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=z("HardDrive",[["line",{x1:"22",x2:"2",y1:"12",y2:"12",key:"1y58io"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16",key:"sgf278"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16",key:"1l4acy"}]]);function te(){var S,q,k,P,_,C,F,E,M,L;const h=R(),[i,c]=x.useState({host:"localhost",port:5432,database:"hmm",username:"hmm_user",password:""}),[l,N]=x.useState(null),[u,p]=x.useState(!1),[D,I]=x.useState(!1),{data:t,isLoading:O}=w({queryKey:["database-status"],queryFn:async()=>{const s=await fetch("/api/settings/database/status");if(!s.ok)throw new Error("Failed to fetch status");return s.json()},refetchInterval:5e3}),{data:a}=w({queryKey:["database-health"],queryFn:async()=>{const s=await fetch("/api/health/database");if(!s.ok)throw new Error("Failed to fetch health");return s.json()},refetchInterval:5e3,enabled:(t==null?void 0:t.active)==="postgresql"});Q.useEffect(()=>{t!=null&&t.postgresql_config&&c({host:t.postgresql_config.host,port:t.postgresql_config.port,database:t.postgresql_config.database,username:t.postgresql_config.username,password:""})},[t]);const b=g({mutationFn:async s=>{const r=await fetch("/api/settings/database/postgresql/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const m=await r.json();throw new Error(m.detail)}return r.json()},onSuccess:s=>{N({success:!0,message:s.message,version:s.version})},onError:s=>{N({success:!1,message:s.message})}}),j=g({mutationFn:async s=>{const r=await fetch("/api/settings/database/postgresql/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const m=await r.json();throw new Error(m.detail)}return r.json()},onSuccess:()=>{h.invalidateQueries({queryKey:["database-status"]}),alert("Configuration saved successfully!")},onError:s=>{alert(`Failed to save: ${s.message}`)}}),y=g({mutationFn:async()=>{const s=await fetch("/api/settings/database/migrate/start",{method:"POST"});if(!s.ok){const r=await s.json();throw new Error(r.detail)}return s.json()},onSuccess:()=>{p(!0);const s=setInterval(()=>{h.invalidateQueries({queryKey:["migration-status"]})},1e3);window.migrationInterval=s},onError:s=>{alert(`Failed to start migration: ${s.message}`)}}),{data:n}=w({queryKey:["migration-status"],queryFn:async()=>{const s=await fetch("/api/settings/database/migrate/status");if(!s.ok)throw new Error("Failed to fetch migration status");return s.json()},enabled:u,refetchInterval:u?1e3:!1});Q.useEffect(()=>{n&&!n.running&&n.result&&(window.migrationInterval&&(clearInterval(window.migrationInterval),window.migrationInterval=null),I(!0))},[n]);const o=g({mutationFn:async()=>{const s=await fetch("/api/settings/database/migrate/validate",{method:"POST"});if(!s.ok){const r=await s.json();throw new Error(r.detail)}return s.json()}}),f=g({mutationFn:async s=>{const r=await fetch(`/api/settings/database/switch?target=${s}`,{method:"POST"});if(!r.ok){const m=await r.json();throw new Error(m.detail)}return r.json()},onSuccess:s=>{s.restart_required?confirm("Database switched! Container restart required. Restart now?")&&fetch("/api/settings/restart",{method:"POST"}):alert(s.message),h.invalidateQueries({queryKey:["database-status"]})},onError:s=>{alert(`Failed to switch: ${s.message}`)}});return O?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(d,{className:"h-8 w-8 animate-spin text-blue-500"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(T,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Database Configuration"})]}),(t==null?void 0:t.active)==="postgresql"&&a&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Connection Pool"}),e.jsx(A,{className:`h-4 w-4 ${a.status==="critical"?"text-red-400":a.status==="warning"?"text-yellow-400":"text-green-400"}`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-baseline space-x-2",children:[e.jsxs("span",{className:"text-2xl font-bold text-white",children:[a.pool.utilization_percent,"%"]}),e.jsx("span",{className:"text-sm text-gray-400",children:"utilized"})]}),e.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all ${a.pool.utilization_percent>90?"bg-red-500":a.pool.utilization_percent>80?"bg-yellow-500":"bg-green-500"}`,style:{width:`${a.pool.utilization_percent}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500",children:[a.pool.checked_out,"/",a.pool.total_capacity," connections"]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Active Queries"}),e.jsx(H,{className:"h-4 w-4 text-blue-400"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:((S=a.postgresql)==null?void 0:S.active_connections)||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"running queries"}),a.postgresql&&a.postgresql.long_running_queries>0&&e.jsxs("p",{className:"text-xs text-yellow-400 flex items-center space-x-1",children:[e.jsx($,{className:"h-3 w-3"}),e.jsxs("span",{children:[a.postgresql.long_running_queries," slow (",">","1min)"]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Database Size"}),e.jsx(J,{className:"h-4 w-4 text-purple-400"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-2xl font-bold text-white",children:[((q=a.postgresql)==null?void 0:q.database_size_mb.toFixed(1))||"0"," MB"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"total storage"})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Health Status"}),e.jsx(K,{className:`h-4 w-4 ${a.status==="healthy"?"text-green-400":a.status==="warning"?"text-yellow-400":"text-red-400"}`})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${a.status==="healthy"?"bg-green-900/30 text-green-400 border border-green-700":a.status==="warning"?"bg-yellow-900/30 text-yellow-400 border border-yellow-700":"bg-red-900/30 text-red-400 border border-red-700"}`,children:a.status.toUpperCase()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[a.status==="healthy"&&"All systems operational",a.status==="warning"&&"Pool usage high",a.status==="critical"&&"Pool nearly exhausted"]})]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Current Database"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`px-4 py-2 rounded-lg font-mono text-lg ${(t==null?void 0:t.active)==="postgresql"?"bg-green-900/30 text-green-400 border border-green-700":"bg-blue-900/30 text-blue-400 border border-blue-700"}`,children:((k=t==null?void 0:t.active)==null?void 0:k.toUpperCase())||"SQLITE"}),(t==null?void 0:t.active)==="sqlite"&&e.jsx("p",{className:"text-gray-400 text-sm",children:"SQLite is simple but has concurrency limitations. Consider PostgreSQL for better performance."}),(t==null?void 0:t.active)==="postgresql"&&t.postgresql_configured&&e.jsxs("p",{className:"text-gray-400 text-sm",children:["Connected to: ",(P=t.postgresql_config)==null?void 0:P.host,":",(_=t.postgresql_config)==null?void 0:_.port,"/",(C=t.postgresql_config)==null?void 0:C.database]})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"PostgreSQL Configuration"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Host"}),e.jsx("input",{type:"text",value:i.host,onChange:s=>c({...i,host:s.target.value}),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white",placeholder:"localhost"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Port"}),e.jsx("input",{type:"number",value:i.port,onChange:s=>c({...i,port:parseInt(s.target.value)}),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white",placeholder:"5432"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Database Name"}),e.jsx("input",{type:"text",value:i.database,onChange:s=>c({...i,database:s.target.value}),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white",placeholder:"hmm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Username"}),e.jsx("input",{type:"text",value:i.username,onChange:s=>c({...i,username:s.target.value}),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white",placeholder:"hmm_user"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:i.password,onChange:s=>c({...i,password:s.target.value}),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white",placeholder:"Enter password"})]})]}),l&&e.jsxs("div",{className:`mb-4 p-3 rounded-md border ${l.success?"bg-green-900/30 border-green-700 text-green-400":"bg-red-900/30 border-red-700 text-red-400"}`,children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[l.success?e.jsx(v,{className:"h-5 w-5"}):e.jsx($,{className:"h-5 w-5"}),e.jsx("span",{children:l.message})]}),l.version&&e.jsx("p",{className:"text-sm mt-1 text-gray-400",children:l.version})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>b.mutate(i),disabled:b.isPending||!i.password,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-md font-medium flex items-center space-x-2",children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Testing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Test Connection"})]})}),e.jsx("button",{onClick:()=>j.mutate(i),disabled:j.isPending||!(l!=null&&l.success),className:"px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-md font-medium flex items-center space-x-2",children:j.isPending?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Saving..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Save Configuration"})]})})]})]}),(t==null?void 0:t.postgresql_configured)&&t.active==="sqlite"&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Migrate to PostgreSQL"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"This will copy all data from SQLite to PostgreSQL. Your SQLite database will remain as a backup. The process may take 10-15 minutes depending on data size."}),e.jsx("button",{onClick:()=>y.mutate(),disabled:y.isPending,className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-md font-medium flex items-center space-x-2",children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Starting..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Start Migration"})]})})]}),u&&n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto border border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Migration Progress"}),e.jsx("div",{className:"space-y-2 mb-4 max-h-96 overflow-y-auto",children:n.progress.map((s,r)=>e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[s.progress===100?e.jsx(v,{className:"h-4 w-4 text-green-400 flex-shrink-0"}):e.jsx(d,{className:"h-4 w-4 animate-spin text-blue-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:s.message})]},r))}),n.result&&e.jsxs("div",{className:`p-4 rounded-md border mb-4 ${n.result.success?"bg-green-900/30 border-green-700":"bg-red-900/30 border-red-700"}`,children:[e.jsx("p",{className:"font-medium",children:n.result.message}),n.result.errors.length>0&&e.jsx("ul",{className:"mt-2 text-sm space-y-1",children:n.result.errors.map((s,r)=>e.jsxs("li",{className:"text-red-400",children:["â€¢ ",s]},r))})]}),D&&((F=n.result)==null?void 0:F.success)&&e.jsxs("div",{className:"mb-4",children:[e.jsx("button",{onClick:()=>o.mutate(),disabled:o.isPending,className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-md font-medium flex items-center justify-center space-x-2",children:o.isPending?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Validating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Validate Migration"})]})}),o.data&&e.jsxs("div",{className:`mt-3 p-3 rounded-md border ${o.data.success?"bg-green-900/30 border-green-700 text-green-400":"bg-red-900/30 border-red-700 text-red-400"}`,children:[e.jsx("p",{children:o.data.message}),((E=o.data.mismatches)==null?void 0:E.length)>0&&e.jsx("ul",{className:"mt-2 text-sm",children:o.data.mismatches.map((s,r)=>e.jsxs("li",{children:[s.table,": SQLite=",s.sqlite_rows,", PostgreSQL=",s.postgresql_rows]},r))})]})]}),((M=n.result)==null?void 0:M.success)&&((L=o.data)==null?void 0:L.success)&&e.jsx("button",{onClick:()=>{p(!1),f.mutate("postgresql")},disabled:f.isPending,className:"w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 rounded-md font-medium flex items-center justify-center space-x-2",children:f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"})," ",e.jsx("span",{children:"Switching..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Switch to PostgreSQL"})]})}),!n.running&&e.jsx("button",{onClick:()=>p(!1),className:"w-full mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md font-medium",children:"Close"})]})}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center space-x-2",children:[e.jsx(U,{className:"h-5 w-5"}),e.jsx("span",{children:"PostgreSQL Setup with Docker"})]}),e.jsx("p",{className:"text-gray-400 mb-4 text-sm",children:"Add this to your docker-compose.yml to run PostgreSQL alongside HMM-Local:"}),e.jsx("pre",{className:"bg-gray-900 p-4 rounded-md overflow-x-auto text-sm",children:`version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: HMM-PostgreSQL
    restart: unless-stopped
    environment:
      POSTGRES_DB: hmm
      POSTGRES_USER: hmm_user
      POSTGRES_PASSWORD: your_secure_password_here
    volumes:
      - hmm-postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - hmm-network

  hmm-local:
    # ... your existing HMM-Local config
    depends_on:
      - postgres
    networks:
      - hmm-network

volumes:
  hmm-postgres-data:

networks:
  hmm-network:`}),e.jsxs("p",{className:"text-gray-400 mt-4 text-sm",children:["After starting PostgreSQL, use ",e.jsx("code",{className:"bg-gray-900 px-2 py-1 rounded",children:"postgres"})," as the host in the configuration above."]})]})]})}export{te as default};
