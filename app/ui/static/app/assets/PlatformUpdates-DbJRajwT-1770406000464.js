import{c as P,r as l,j as e,R as p,w as y}from"./index-C6-72zJp-1770406000464.js";import{A as g}from"./alert-triangle-BHnooMi0-1770406000464.js";import{I as F}from"./info-C2eDOFYD-1770406000464.js";import{D as T}from"./download-BI82ONKH-1770406000464.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=P("ExternalLink",[["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}],["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["line",{x1:"10",x2:"21",y1:"14",y2:"3",key:"18c3s4"}]]),M=()=>{const[n,N]=l.useState(null),[t,v]=l.useState(null),[u,w]=l.useState([]),[a,k]=l.useState(null),[o,c]=l.useState(!0),[C,i]=l.useState(!1),[d,j]=l.useState(null),f=async()=>{try{const s=await fetch("/api/updates/container");if(s.ok){const r=await s.json();N(r)}}catch(s){console.error("Failed to fetch container info:",s)}},m=async()=>{try{const s=await fetch("/api/updates/check");if(s.ok){const r=await s.json();v(r)}}catch(s){console.error("Failed to fetch version info:",s)}},x=async()=>{try{const s=await fetch("/api/updates/changelog");if(s.ok){const r=await s.json();w(r)}}catch(s){console.error("Failed to fetch changelog:",s)}},b=async()=>{try{const s=await fetch("/api/updates/status");if(s.ok){const r=await s.json();if(k(r),r.status!=="idle"&&r.status!=="completed"&&r.status!=="error")return!0;if(r.status==="completed"||r.status==="error")return setTimeout(()=>{f(),m(),x()},2e3),!1}return!1}catch(s){return console.error("Failed to fetch update status:",s),!1}},_=()=>{if(d)return;const s=setInterval(async()=>{await b()||(clearInterval(s),j(null))},2e3);j(s)};l.useEffect(()=>((async()=>{c(!0),await Promise.all([f(),m(),x(),b()]),c(!1)})(),()=>{d&&clearInterval(d)}),[]);const I=async()=>{c(!0),await Promise.all([m(),x()]),c(!1)},U=async()=>{try{const s=await fetch("/api/updates/apply",{method:"POST",headers:{"Content-Type":"application/json"}});if(s.ok)i(!1),_();else{const r=await s.json();alert(`Update failed: ${r.detail}`)}}catch(s){console.error("Failed to start update:",s),alert("Failed to start update")}},h=s=>s?new Date(s).toLocaleString("en-GB",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Unknown",D=s=>{switch(s){case"completed":return"text-green-400";case"error":return"text-red-400";case"checking":case"pulling":case"stopping":case"starting":return"text-yellow-400";default:return"text-gray-400"}},S=s=>{switch(s){case"completed":return e.jsx(y,{className:"w-5 h-5"});case"error":return e.jsx(g,{className:"w-5 h-5"});default:return e.jsx(p,{className:"w-5 h-5 animate-spin"})}};return o&&!t?e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:e.jsx(p,{className:"w-8 h-8 text-purple-500 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-gray-100",children:[e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Platform Updates"}),e.jsx("p",{className:"text-gray-400",children:"Manage system updates from GitHub Container Registry"})]}),e.jsxs("button",{onClick:I,disabled:o||(a==null?void 0:a.status)!=="idle",className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg transition-colors",children:[e.jsx(p,{className:`w-4 h-4 ${o?"animate-spin":""}`}),"Refresh"]})]}),a&&a.error&&a.error.includes("docker.sock")&&e.jsxs("div",{className:"bg-yellow-900 bg-opacity-30 border-2 border-yellow-600 rounded-lg p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2 text-yellow-400",children:[e.jsx(g,{className:"w-5 h-5"}),"Docker Socket Not Mounted"]}),e.jsx("p",{className:"text-gray-300 mb-4",children:"Platform Updates requires access to the Docker socket. Add this to your deployment:"}),e.jsxs("div",{className:"bg-gray-900 rounded p-4 font-mono text-sm overflow-x-auto",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:"# For docker run:"}),e.jsx("div",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock"}),e.jsx("div",{className:"mt-4 text-gray-400 mb-2",children:"# Complete example:"}),e.jsxs("div",{className:"text-gray-300",children:["docker run -d \\",e.jsx("br",{}),"  --name hmm-local \\",e.jsx("br",{}),"  --network bridge \\",e.jsx("br",{}),"  -p 8080:8080 \\",e.jsx("br",{}),"  -v /data/hmm-local:/config \\",e.jsx("br",{}),"  ",e.jsx("span",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock \\"}),e.jsx("br",{}),"  --restart unless-stopped \\",e.jsx("br",{}),"  ghcr.io/renegadeuk/hmm-local:latest"]})]}),e.jsx("p",{className:"text-yellow-200 text-sm mt-4",children:"⚠️ After adding the Docker socket, restart your container for Platform Updates to work."})]}),n&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5 text-purple-500"}),"Container Information"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Container Name:"}),e.jsx("span",{className:"ml-2 font-mono",children:n.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Image:"}),e.jsx("span",{className:"ml-2 font-mono",children:n.image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Network:"}),e.jsx("span",{className:"ml-2 font-mono",children:n.network_mode})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"IP Address:"}),e.jsx("span",{className:"ml-2 font-mono",children:n.ip_address})]})]})]}),a&&a.status!=="idle"&&e.jsxs("div",{className:`bg-gray-800 rounded-lg p-6 mb-6 border-2 ${a.status==="completed"?"border-green-600":a.status==="error"?"border-red-600":"border-yellow-600"}`,children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:D(a.status),children:S(a.status)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold capitalize",children:a.status}),e.jsx("p",{className:"text-gray-400",children:a.message}),a.error&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:a.error})]}),e.jsxs("div",{className:"text-2xl font-bold",children:[a.progress,"%"]})]}),a.status!=="completed"&&a.status!=="error"&&e.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${a.progress}%`}})})]}),t&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Version Information"}),t.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-yellow-600 text-white rounded-full text-sm font-semibold",children:["Update Available (",t.commits_behind," commits behind)"]}),!t.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-green-600 text-white rounded-full text-sm font-semibold flex items-center gap-1",children:[e.jsx(y,{className:"w-4 h-4"}),"Up to Date"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-400 mb-3",children:"Current Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:t.current_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:t.current_tag})]}),t.current_commit&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:t.current_commit.substring(0,7)})]}),t.current_message&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:t.current_message})]}),t.current_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:h(t.current_date)})]})]})]})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border-2 border-purple-600",children:[e.jsx("h3",{className:"text-lg font-semibold text-purple-400 mb-3",children:"Latest Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:t.latest_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:t.latest_tag})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:t.latest_commit.substring(0,7)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:t.latest_message})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:h(t.latest_date)})]})]})]})]}),t.update_available&&(a==null?void 0:a.status)==="idle"&&e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:()=>i(!0),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:[e.jsx(T,{className:"w-5 h-5"}),"Update to ",t.latest_tag]})})]}),u.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Recent Commits"}),e.jsx("div",{className:"space-y-3",children:u.slice(0,10).map(s=>e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 hover:bg-gray-850 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold mb-1",children:s.message}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400",children:[e.jsx("span",{className:"font-mono",children:s.sha_short}),e.jsx("span",{children:s.author}),e.jsx("span",{children:h(s.date)})]})]}),e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"text-purple-500 hover:text-purple-400 transition-colors",title:"View on GitHub",children:e.jsx(R,{className:"w-5 h-5"})})]})},s.sha))})]})]}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-6 h-6 text-yellow-500"}),"Confirm Update"]}),e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsx("p",{className:"text-gray-300",children:"This will update the system to the latest version from GitHub Container Registry."}),e.jsxs("div",{className:"bg-gray-900 rounded p-3 space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"From:"})," ",e.jsx("span",{className:"font-mono",children:t==null?void 0:t.current_tag})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"To:"})," ",e.jsx("span",{className:"font-mono text-purple-400",children:t==null?void 0:t.latest_tag})]})]}),e.jsx("div",{className:"bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-3",children:e.jsx("p",{className:"text-yellow-200 text-sm",children:"⚠️ The container will restart during the update. Your network settings and configuration will be preserved."})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>i(!1),className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:U,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:"Confirm Update"})]})]})})]})};export{M as default};
