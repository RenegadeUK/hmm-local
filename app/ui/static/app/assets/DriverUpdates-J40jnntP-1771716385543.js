import{m as B,r as c,j as e,R as y,z as A,A as h,ai as K}from"./index-BD9hvQWc-1771716385543.js";import{D as q}from"./download-B2PZV4n4-1771716385543.js";const Y=()=>{const g=B(),[m,U]=c.useState([]),[f,E]=c.useState("all"),[b,C]=c.useState(!0),[o,x]=c.useState(null),[d,a]=c.useState(null),[T,u]=c.useState(!1),[j,R]=c.useState(!1);c.useEffect(()=>{p()},[]);const p=async()=>{try{C(!0);const[t,s]=await Promise.all([fetch("/api/drivers/status"),fetch("/api/drivers/energy-providers/status")]);if(!t.ok||!s.ok)throw new Error("Failed to fetch driver status");const r=await t.json(),l=(await s.json()).map(n=>({name:n.name,driver_type:n.provider_id,category:"energy",display_name:n.display_name,current_version:n.current_version,available_version:n.available_version,status:n.status,description:n.description}));U([...r,...l])}catch(t){console.error("Error fetching driver status:",t),a({type:"error",text:"Failed to load driver information"})}finally{C(!1)}},F=async()=>{if(confirm("Restart the container now? This will briefly interrupt service."))try{if(R(!0),(await fetch("/api/settings/restart",{method:"POST"})).ok)a({type:"success",text:"Container restart initiated. Page will reload in 10 seconds..."}),setTimeout(()=>{window.location.reload()},1e4);else throw new Error("Restart request failed")}catch(t){a({type:"error",text:`Failed to restart container: ${t.message}`}),R(!1)}},I=async(t,s)=>{try{x(t),a(null);const r=s==="energy"?`/api/drivers/energy-providers/update/${t}`:`/api/drivers/update/${s}/${t}`,i=await fetch(r,{method:"POST"}),l=await i.json();if(i.ok)a({type:"success",text:`${t} updated successfully! Restart required to load new version.`}),u(!0),await p(),g.invalidateQueries({queryKey:["driver-updates"]});else throw new Error(l.detail||"Update failed")}catch(r){a({type:"error",text:`Failed to update ${t}: ${r.message}`})}finally{x(null)}},L=async(t,s)=>{try{x(t),a(null);const r=s==="energy"?`/api/drivers/energy-providers/update/${t}`:`/api/drivers/install/${s}/${t}`,i=await fetch(r,{method:"POST"}),l=await i.json();if(i.ok)a({type:"success",text:`${t} installed successfully! Restart required to load update.`}),u(!0),await p(),g.invalidateQueries({queryKey:["driver-updates"]});else throw new Error(l.detail||"Installation failed")}catch(r){a({type:"error",text:`Failed to install ${t}: ${r.message}`})}finally{x(null)}},M=async()=>{var t,s,r,i;try{x("all"),a(null);const[l,n]=await Promise.all([fetch("/api/drivers/update-all",{method:"POST"}),fetch("/api/drivers/energy-providers/update-all",{method:"POST"})]),[k,$]=await Promise.all([l.json(),n.json()]);if(l.ok&&n.ok){const P=(((t=k.updated)==null?void 0:t.length)||0)+(((s=$.updated)==null?void 0:s.length)||0),S=(((r=k.failed)==null?void 0:r.length)||0)+(((i=$.failed)==null?void 0:i.length)||0);S>0?a({type:"error",text:`Updated ${P} driver(s), but ${S} failed. Check logs for details.`}):a({type:"success",text:`Successfully updated ${P} driver(s)! Restart required.`}),u(!0),await p(),g.invalidateQueries({queryKey:["driver-updates"]})}else throw new Error(k.detail||$.detail||"Update all failed")}catch(l){a({type:"error",text:`Failed to update drivers: ${l.message}`})}finally{x(null)}},O=t=>{switch(t){case"up_to_date":return e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Up to Date"]});case"update_available":return e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:[e.jsx(h,{className:"w-3 h-3 mr-1"}),"Update Available"]});case"not_installed":return e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[e.jsx(K,{className:"w-3 h-3 mr-1"}),"Not Installed"]});default:return null}},_=m.filter(t=>t.status==="update_available").length,w=t=>m.filter(s=>s.category===t).length,D=f==="all"?m:m.filter(t=>t.category===f),v=D.filter(t=>t.status==="not_installed"),N=D.filter(t=>t.status!=="not_installed"),Q=[{key:"all",label:"All",count:m.length},{key:"pool",label:"Pool",count:w("pool")},{key:"miner",label:"Miner",count:w("miner")},{key:"energy",label:"Energy",count:w("energy")}];return b?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(y,{className:"w-8 h-8 animate-spin text-blue-500"})}):e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-100",children:"Driver Management"}),e.jsx("p",{className:"mt-1 text-sm text-gray-400",children:"Manage pool, miner, and energy provider updates in one place"})]}),d&&e.jsx("div",{className:`mb-6 p-4 rounded-md ${d.type==="success"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:d.type==="success"?e.jsx(A,{className:"h-5 w-5 text-green-400"}):e.jsx(h,{className:"h-5 w-5 text-red-400"})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:`text-sm font-medium ${d.type==="success"?"text-green-800":"text-red-800"}`,children:d.text})}),e.jsx("div",{className:"ml-auto pl-3",children:e.jsxs("button",{type:"button",onClick:()=>a(null),className:"inline-flex rounded-md p-1.5 hover:bg-opacity-75 focus:outline-none",children:[e.jsx("span",{className:"sr-only",children:"Dismiss"}),e.jsx("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})]})})]})}),T&&e.jsx("div",{className:"mb-6 p-4 rounded-md bg-yellow-900/40 border border-yellow-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h,{className:"h-5 w-5 text-yellow-400 mr-3"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-yellow-200",children:"Container restart required to load updated drivers/providers"}),e.jsx("p",{className:"text-xs text-yellow-300 mt-1",children:"You can restart now or manually restart the container later"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>u(!1),className:"text-sm text-gray-400 hover:text-gray-300",children:"Ignore"}),e.jsxs("button",{onClick:F,disabled:j,className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 disabled:opacity-50",children:[e.jsx(y,{className:`w-4 h-4 mr-2 ${j?"animate-spin":""}`}),j?"Restarting...":"Restart Now"]})]})]})}),e.jsxs("div",{className:"mb-6 flex items-center justify-between bg-gray-900/80 border border-gray-800 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{onClick:p,disabled:b,className:"inline-flex items-center px-4 py-2 border border-gray-700 rounded-md text-sm font-medium text-gray-300 bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(y,{className:`w-4 h-4 mr-2 ${b?"animate-spin":""}`}),"Refresh"]}),_>0&&e.jsxs("button",{onClick:M,disabled:o!==null,className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(q,{className:`w-4 h-4 mr-2 ${o==="all"?"animate-bounce":""}`}),"Update All (",_,")"]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[N.length," installed â€¢ ",v.length," available"]})]}),e.jsx("div",{className:"mb-6 flex flex-wrap items-center gap-2",children:Q.map(t=>{const s=f===t.key;return e.jsxs("button",{onClick:()=>E(t.key),className:`inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium border transition-colors ${s?"bg-blue-600 border-blue-500 text-white":"bg-gray-900/70 border-gray-700 text-gray-300 hover:bg-gray-800"}`,children:[t.label,e.jsx("span",{className:`ml-2 inline-flex items-center justify-center rounded-full px-2 py-0.5 text-xs ${s?"bg-blue-500 text-white":"bg-gray-700 text-gray-200"}`,children:t.count})]},t.key)})}),N.length>0&&e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-4",children:"Installed Drivers"}),e.jsx("div",{className:"bg-gray-900/80 border border-gray-800 overflow-hidden rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-800",children:[e.jsx("thead",{className:"bg-gray-800/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Driver"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Current Version"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Available Version"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Action"})]})}),e.jsx("tbody",{className:"bg-gray-900/40 divide-y divide-gray-800",children:N.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-100",children:t.display_name}),e.jsx("div",{className:"text-sm text-gray-400",children:t.name})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:t.driver_type}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-200",children:t.current_version||"unknown"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-200",children:t.available_version}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:O(t.status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:t.status==="update_available"?e.jsx("button",{onClick:()=>I(t.name,t.category),disabled:o!==null,className:"text-blue-600 hover:text-blue-900 disabled:opacity-50 disabled:cursor-not-allowed",children:o===t.name?"Updating...":"Update"}):e.jsx("span",{className:"text-gray-400",children:"Up to date"})})]},`${t.category}:${t.name}`))})]})})]}),v.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-4",children:"Available Drivers"}),e.jsx("div",{className:"bg-gray-900/80 border border-gray-800 overflow-hidden rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-800",children:[e.jsx("thead",{className:"bg-gray-800/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Driver"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Version"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider",children:"Action"})]})}),e.jsx("tbody",{className:"bg-gray-900/40 divide-y divide-gray-800",children:v.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-100",children:t.display_name}),e.jsx("div",{className:"text-sm text-gray-400",children:t.name})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:t.driver_type}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-200",children:t.available_version}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-400",children:t.description||"No description available"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsx("button",{onClick:()=>L(t.name,t.category),disabled:o!==null,className:"inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed",children:o===t.name?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-4 h-4 mr-1 animate-spin"}),"Installing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"Install"]})})})]},`${t.category}:${t.name}`))})]})})]}),(d==null?void 0:d.type)==="success"&&e.jsx("div",{className:"mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(h,{className:"h-5 w-5 text-yellow-400"})}),e.jsx("div",{className:"ml-3",children:e.jsxs("p",{className:"text-sm text-yellow-700",children:[e.jsx("strong",{children:"Important:"})," Container restart required for driver changes to take effect. Run: ",e.jsx("code",{className:"bg-yellow-100 px-2 py-1 rounded",children:"docker-compose restart"})]})})]})})]})};export{Y as default};
