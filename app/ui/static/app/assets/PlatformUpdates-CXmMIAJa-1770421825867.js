import{c as W,r as n,j as e,R as h,x as p}from"./index-BuJ2EJa--1770421825867.js";import{A as u}from"./alert-triangle-yci6_lRx-1770421825867.js";import{I as g}from"./info-pXPEmJDR-1770421825867.js";import{D as Y}from"./download-DuCkbDmD-1770421825867.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=W("ExternalLink",[["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}],["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["line",{x1:"10",x2:"21",y1:"14",y2:"3",key:"18c3s4"}]]),ee=()=>{const[d,$]=n.useState(null),[a,H]=n.useState(null),[C,R]=n.useState([]),[r,o]=n.useState(null),[l,f]=n.useState({status:"unknown",service:"",timestamp:null,error:null}),[i,E]=n.useState(null),[j,U]=n.useState(!1),[b,x]=n.useState(!0),[V,y]=n.useState(!1),[N,_]=n.useState(null),T=async()=>{try{const s=await fetch("/api/updates/container");if(s.ok){const t=await s.json();$(t)}}catch(s){console.error("Failed to fetch container info:",s)}},v=async()=>{try{const s=await fetch("/api/updates/check");if(s.ok){const t=await s.json();H(t)}}catch(s){console.error("Failed to fetch version info:",s)}},w=async()=>{try{const s=await fetch("/api/updates/changelog");if(s.ok){const t=await s.json();R(t)}}catch(s){console.error("Failed to fetch changelog:",s)}},I=async()=>{try{const s=await fetch("/api/updates/updater-health");if(s.ok){const t=await s.json();f({status:"healthy",service:t.service||"hmm-local-updater",timestamp:t.timestamp,error:null})}else{const t=await s.json();f({status:"unhealthy",service:"hmm-local-updater",timestamp:null,error:t.detail||"Connection failed"})}}catch(s){f({status:"unhealthy",service:"hmm-local-updater",timestamp:null,error:s instanceof Error?s.message:"Connection failed"})}},S=async()=>{try{const s=await fetch("/api/updates/updater-version");if(s.ok){const t=await s.json();E(t)}}catch(s){console.error("Failed to fetch updater version:",s)}},P=async()=>{try{const s=await fetch("/api/updates/status");if(s.ok){const t=await s.json();if((t.status!=="idle"&&t.status!=="completed"||r!==null)&&o(t),t.status==="restarting"||t.status==="success"||t.progress>=60&&t.message.includes("restart"))return A(),!1;if(t.status!=="idle"&&t.status!=="completed"&&t.status!=="error")return!0;if(t.status==="completed"||t.status==="error")return setTimeout(()=>{T(),v(),w()},2e3),!1}return!1}catch(s){return console.error("Failed to fetch update status:",s),!1}},A=()=>{console.log("ðŸ”„ Starting container health check..."),o(c=>c?{...c,status:"starting",message:"Container restarting... Checking health...",progress:70}:null);let s=0;const t=60,D=setInterval(async()=>{if(s++,s%5===0){const c=Math.min(70+s/t*25,95);o(m=>m?{...m,message:`Container restarting... (${s}s)`,progress:c}:null)}try{const c=Date.now(),m=new AbortController,B=setTimeout(()=>m.abort(),2e3),F=await fetch(`/health?t=${c}`,{method:"GET",cache:"no-cache",signal:m.signal});clearTimeout(B),F.ok?(console.log("âœ… Container is healthy! Redirecting to home..."),clearInterval(D),o({status:"completed",message:"Update completed successfully! Redirecting...",progress:100,error:null}),setTimeout(()=>{window.location.href="/"},1500)):console.log(`â³ Health check attempt ${s}: not ready yet (status ${F.status})`)}catch(c){console.log(`â³ Health check attempt ${s}: ${c instanceof Error?c.message:"connection failed"}`),s>=t&&(console.error("âŒ Container health check timed out"),clearInterval(D),o({status:"error",message:"Container restart is taking longer than expected. Redirecting to home...",progress:95,error:"Timeout waiting for container"}),setTimeout(()=>{console.log("ðŸ”„ Redirecting to home page..."),window.location.href="/"},3e3))}},1e3)},L=()=>{if(N)return;const s=setInterval(async()=>{await P()||(clearInterval(s),_(null))},2e3);_(s)};n.useEffect(()=>((async()=>{x(!0),await Promise.all([T(),v(),w(),P(),I(),S()]),x(!1)})(),()=>{N&&clearInterval(N)}),[]);const G=async()=>{x(!0);try{await fetch("/api/updates/refresh",{method:"POST"})}catch(s){console.error("Failed to refresh GitHub cache:",s)}await new Promise(s=>setTimeout(s,1e3)),await Promise.all([v(),w()]),x(!1)},M=async()=>{try{o({status:"checking",message:"Starting update...",progress:0,error:null});const s=await fetch("/api/updates/apply",{method:"POST",headers:{"Content-Type":"application/json"}});if(s.ok)y(!1),L();else{const t=await s.json();o({status:"error",message:"Update failed",progress:0,error:t.detail||"Unknown error"})}}catch(s){console.error("Failed to start update:",s),o({status:"error",message:"Failed to start update",progress:0,error:s instanceof Error?s.message:"Unknown error"})}},q=async()=>{if(confirm("Update the updater sidecar container? This will restart the updater service briefly.")){U(!0);try{const s=await fetch("/api/updates/updater/update",{method:"POST"});if(s.ok)await new Promise(t=>setTimeout(t,2e3)),await S(),await I();else{const t=await s.json();alert(`Updater update failed: ${t.detail}`)}}catch(s){console.error("Failed to update updater:",s),alert(`Failed to update updater: ${s instanceof Error?s.message:"Unknown error"}`)}finally{U(!1)}}},k=s=>s?new Date(s).toLocaleString("en-GB",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Unknown",z=s=>{switch(s){case"completed":return"text-green-400";case"error":return"text-red-400";case"checking":case"pulling":case"stopping":case"starting":return"text-yellow-400";default:return"text-gray-400"}},O=s=>{switch(s){case"completed":return e.jsx(p,{className:"w-5 h-5"});case"error":return e.jsx(u,{className:"w-5 h-5"});default:return e.jsx(h,{className:"w-5 h-5 animate-spin"})}};return b&&!a?e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:e.jsx(h,{className:"w-8 h-8 text-purple-500 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-900 text-gray-100",children:[e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Platform Updates"}),e.jsx("p",{className:"text-gray-400",children:"Manage system updates from GitHub Container Registry"}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${l.status==="healthy"?"bg-green-900 bg-opacity-30 text-green-400 border border-green-600":l.status==="unhealthy"?"bg-red-900 bg-opacity-30 text-red-400 border border-red-600":"bg-gray-800 text-gray-400 border border-gray-600"}`,children:[l.status==="healthy"&&e.jsx(p,{className:"w-4 h-4"}),l.status==="unhealthy"&&e.jsx(u,{className:"w-4 h-4"}),l.status==="unknown"&&e.jsx(g,{className:"w-4 h-4"}),e.jsxs("span",{children:[l.status==="healthy"&&"Updater Connected",l.status==="unhealthy"&&"Updater Disconnected",l.status==="unknown"&&"Checking updater..."]})]}),l.error&&e.jsxs("span",{className:"text-xs text-red-400",children:["(",l.error,")"]})]})]}),e.jsxs("button",{onClick:G,disabled:b||(r==null?void 0:r.status)!=="idle"&&r!==null,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg transition-colors",children:[e.jsx(h,{className:`w-4 h-4 ${b?"animate-spin":""}`}),"Refresh"]})]}),r&&r.error&&r.error.includes("docker.sock")&&e.jsxs("div",{className:"bg-yellow-900 bg-opacity-30 border-2 border-yellow-600 rounded-lg p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2 text-yellow-400",children:[e.jsx(u,{className:"w-5 h-5"}),"Docker Socket Not Mounted"]}),e.jsx("p",{className:"text-gray-300 mb-4",children:"Platform Updates requires access to the Docker socket. Add this to your deployment:"}),e.jsxs("div",{className:"bg-gray-900 rounded p-4 font-mono text-sm overflow-x-auto",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:"# For docker run:"}),e.jsx("div",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock"}),e.jsx("div",{className:"mt-4 text-gray-400 mb-2",children:"# Complete example:"}),e.jsxs("div",{className:"text-gray-300",children:["docker run -d \\",e.jsx("br",{}),"Â Â --name hmm-local \\",e.jsx("br",{}),"Â Â --network bridge \\",e.jsx("br",{}),"Â Â -p 8080:8080 \\",e.jsx("br",{}),"Â Â -v /data/hmm-local:/config \\",e.jsx("br",{}),"Â Â ",e.jsx("span",{className:"text-green-400",children:"-v /var/run/docker.sock:/var/run/docker.sock \\"}),e.jsx("br",{}),"Â Â --restart unless-stopped \\",e.jsx("br",{}),"Â Â ghcr.io/renegadeuk/hmm-local:latest"]})]}),e.jsx("p",{className:"text-yellow-200 text-sm mt-4",children:"âš ï¸ After adding the Docker socket, restart your container for Platform Updates to work."})]}),d&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5 text-purple-500"}),"Container Information"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Container Name:"}),e.jsx("span",{className:"ml-2 font-mono",children:d.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Image:"}),e.jsx("span",{className:"ml-2 font-mono",children:d.image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Network:"}),e.jsx("span",{className:"ml-2 font-mono",children:d.network_mode})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"IP Address:"}),e.jsx("span",{className:"ml-2 font-mono",children:d.ip_address})]})]})]}),!d&&a&&e.jsxs("div",{className:"bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-3 flex items-center gap-2 text-yellow-500",children:[e.jsx(g,{className:"w-5 h-5"}),"Container Information Unavailable"]}),e.jsx("p",{className:"text-gray-300 mb-3",children:"Docker socket is not mounted. To enable full container detection, add this to your deployment:"}),e.jsx("div",{className:"bg-gray-900 rounded p-3 font-mono text-sm text-gray-300 overflow-x-auto",children:"-v /var/run/docker.sock:/var/run/docker.sock"}),e.jsx("p",{className:"text-gray-400 text-sm mt-3",children:"Without the socket, Platform Updates can still check for new versions but cannot detect the current container's metadata."})]}),r&&r.status!=="idle"&&e.jsxs("div",{className:`bg-gray-800 rounded-lg p-6 mb-6 border-2 ${r.status==="completed"?"border-green-600":r.status==="error"?"border-red-600":"border-yellow-600"}`,children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:z(r.status),children:O(r.status)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold capitalize",children:r.status}),e.jsx("p",{className:"text-gray-400",children:r.message}),r.error&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:r.error})]}),e.jsxs("div",{className:"text-2xl font-bold",children:[r.progress,"%"]})]}),r.status!=="completed"&&r.status!=="error"&&e.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${r.progress}%`}})})]}),i&&i.available&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5 text-blue-500"}),"Updater Service"]}),i.update_available&&e.jsx("span",{className:"px-3 py-1 bg-blue-600 text-white rounded-full text-sm font-semibold",children:"Update Available"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400 text-sm",children:"Current Tag:"}),e.jsx("p",{className:"font-mono",children:i.current_tag})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400 text-sm",children:"Latest Tag:"}),e.jsx("p",{className:"font-mono",children:i.latest_tag})]})]}),i.update_available&&e.jsxs("button",{onClick:q,disabled:j,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg font-semibold transition-colors",children:[e.jsx(h,{className:`w-4 h-4 ${j?"animate-spin":""}`}),j?"Updating Updater...":"Update Updater Service"]}),!i.update_available&&e.jsxs("div",{className:"flex items-center gap-2 text-green-400 text-sm",children:[e.jsx(p,{className:"w-4 h-4"}),"Updater service is up to date"]})]}),a&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Version Information"}),a.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-yellow-600 text-white rounded-full text-sm font-semibold",children:["Update Available (",a.commits_behind," commits behind)"]}),!a.update_available&&e.jsxs("span",{className:"px-3 py-1 bg-green-600 text-white rounded-full text-sm font-semibold flex items-center gap-1",children:[e.jsx(p,{className:"w-4 h-4"}),"Up to Date"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-400 mb-3",children:"Current Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:a.current_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:a.current_tag})]}),a.current_commit&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:a.current_commit.substring(0,7)})]}),a.current_message&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:a.current_message})]}),a.current_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:k(a.current_date)})]})]})]})]}),e.jsxs("div",{className:"bg-gray-900 rounded-lg p-4 border-2 border-purple-600",children:[e.jsx("h3",{className:"text-lg font-semibold text-purple-400 mb-3",children:"Latest Version"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Image:"}),e.jsx("p",{className:"font-mono text-sm",children:a.latest_image})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Tag:"}),e.jsx("p",{className:"font-mono",children:a.latest_tag})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Commit:"}),e.jsx("p",{className:"font-mono text-sm",children:a.latest_commit.substring(0,7)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Message:"}),e.jsx("p",{className:"text-sm",children:a.latest_message})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Date:"}),e.jsx("p",{className:"text-sm",children:k(a.latest_date)})]})]})]})]}),a.update_available&&(r===null||r.status==="idle")&&e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:()=>y(!0),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:[e.jsx(Y,{className:"w-5 h-5"}),"Update to ",a.latest_tag]})})]}),C.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Recent Commits"}),e.jsx("div",{className:"space-y-3",children:C.slice(0,10).map(s=>e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 hover:bg-gray-850 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold mb-1",children:s.message}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400",children:[e.jsx("span",{className:"font-mono",children:s.sha_short}),e.jsx("span",{children:s.author}),e.jsx("span",{children:k(s.date)})]})]}),e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"text-purple-500 hover:text-purple-400 transition-colors",title:"View on GitHub",children:e.jsx(J,{className:"w-5 h-5"})})]})},s.sha))})]})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(u,{className:"w-6 h-6 text-yellow-500"}),"Confirm Update"]}),e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsx("p",{className:"text-gray-300",children:"This will update the system to the latest version from GitHub Container Registry."}),e.jsxs("div",{className:"bg-gray-900 rounded p-3 space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"From:"})," ",e.jsx("span",{className:"font-mono",children:a==null?void 0:a.current_tag})]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-400",children:"To:"})," ",e.jsx("span",{className:"font-mono text-purple-400",children:a==null?void 0:a.latest_tag})]})]}),e.jsx("div",{className:"bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-3",children:e.jsx("p",{className:"text-yellow-200 text-sm",children:"âš ï¸ The container will restart during the update. Your network settings and configuration will be preserved."})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>y(!1),className:"flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:M,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors",children:"Confirm Update"})]})]})})]})};export{ee as default};
