import{m as D,r as N,a as S,n as H,j as e,o as E,W as L,C as m,d as x,e as u,f as h,L as I,R as $,a1 as T,a2 as P}from"./index-BJ7BN31t-1771279121309.js";import{C as q}from"./check-circle-2-2EtJ8kLB-1771279121309.js";import{A as Q}from"./alert-triangle-BtSTCyTz-1771279121309.js";const R="hmm_local_stratum";function W(t){return typeof t!="number"||!Number.isFinite(t)?"N/A":`${t.toFixed(2)}%`}function A(t){if(!t)return{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"};const n=new Date(t).getTime();if(Number.isNaN(n))return{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"};const l=Math.max(0,Math.floor((Date.now()-n)/1e3));return l<=60?{label:"Fresh",className:"border-emerald-700/50 bg-emerald-900/30 text-emerald-300"}:l<=180?{label:"Aging",className:"border-amber-700/60 bg-amber-900/30 text-amber-300"}:{label:"Stale",className:"border-red-700/60 bg-red-900/30 text-red-300"}}function U(t){return typeof t!="number"||!Number.isFinite(t)?{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"}:t>=5?{label:"High",className:"border-red-700/60 bg-red-900/30 text-red-300"}:t>=3?{label:"Elevated",className:"border-amber-700/60 bg-amber-900/30 text-amber-300"}:{label:"Normal",className:"border-emerald-700/50 bg-emerald-900/30 text-emerald-300"}}function M(t){if(!t)return"Unknown";const n=new Date(t).getTime();if(Number.isNaN(n))return t;const l=Math.max(0,Math.floor((Date.now()-n)/1e3));if(l<60)return`${l}s ago`;const d=Math.floor(l/60);if(d<60)return`${d}m ago`;const i=Math.floor(d/60);return i<24?`${i}h ago`:`${Math.floor(i/24)}d ago`}function G(){var F,C;const t=D(),[n,l]=N.useState(!1),[d,i]=N.useState(null),b=S({queryKey:["integrations","hmm-local-stratum","settings"],queryFn:()=>T.getHmmLocalStratumSettings(),staleTime:3e4});N.useEffect(()=>{var s;typeof((s=b.data)==null?void 0:s.enabled)=="boolean"&&l(b.data.enabled)},[(F=b.data)==null?void 0:F.enabled]);const y=H({mutationFn:()=>T.saveHmmLocalStratumSettings(n),onSuccess:s=>{i({tone:"success",message:s.message||"Settings saved"}),t.invalidateQueries({queryKey:["integrations","hmm-local-stratum","settings"]}),t.invalidateQueries({queryKey:["layout","stratum-dashboards-enabled"]}),setTimeout(()=>i(null),3500)},onError:s=>{i({tone:"error",message:s.message||"Failed to save settings"}),setTimeout(()=>i(null),3500)}}),_=S({queryKey:["integrations","hmm-local-stratum","tiles"],queryFn:()=>P.getPoolTiles(),refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),k=S({queryKey:["integrations","hmm-local-stratum","recovery-status"],queryFn:()=>P.getRecoveryStatus(24),refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),o=N.useMemo(()=>Object.values(_.data||{}).filter(s=>s.pool_type===R),[_.data]),w=N.useMemo(()=>{var c;const s=new Map;for(const a of((c=k.data)==null?void 0:c.pools)||[])s.set(a.pool_id,a);return s},[(C=k.data)==null?void 0:C.pools]),f=N.useMemo(()=>{const s=o.filter(r=>r.tile_1_health.health_status===!1).length,c=o.reduce((r,g)=>{const v=Number.parseInt(g.pool_id,10),p=Number.isNaN(v)?void 0:w.get(v);return r.recovered+=(p==null?void 0:p.recovered_count)||0,r.unresolved+=(p==null?void 0:p.unresolved_count)||0,r},{recovered:0,unresolved:0}),a=o.filter(r=>A(r.last_updated).label==="Stale").length,j=o.reduce((r,g)=>{var v;return r+(((v=g.warnings)==null?void 0:v.length)||0)},0);return{unhealthyPools:s,staleFeeds:a,driverWarnings:j,recovered:c.recovered,unresolved:c.unresolved}},[w,o]);return _.isLoading?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(E,{className:"h-8 w-8 animate-spin text-blue-500"})}):_.isError?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(L,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"HMM-Local Stratum"})]}),e.jsx("div",{className:"rounded-lg border border-red-700 bg-red-900/30 p-4 text-red-200",children:"Failed to load Stratum operational data."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(L,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"HMM-Local Stratum"})]}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Dedicated operational status view for local Stratum integration pools."})]}),d&&e.jsx("div",{className:`rounded-lg border px-4 py-3 text-sm ${d.tone==="success"?"border-emerald-700/60 bg-emerald-900/30 text-emerald-200":d.tone==="error"?"border-red-700/60 bg-red-900/30 text-red-200":"border-blue-700/60 bg-blue-900/30 text-blue-200"}`,children:d.message}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(u,{children:"HMM-Local Stratum dashboards"})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-start gap-3 rounded-lg border border-slate-700/50 bg-slate-900/30 p-3",children:[e.jsx("input",{type:"checkbox",className:"mt-0.5 h-4 w-4",checked:n,onChange:s=>l(s.target.checked),disabled:b.isLoading||y.isPending}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-slate-100",children:"Enable dedicated HMM-Local Stratum dashboards"}),e.jsx("div",{className:"text-xs text-slate-400",children:"When enabled, a new top-level navigation section appears with BTC, BCH and DGB pages focused on mining pool data."})]})]}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-md border border-blue-700/60 bg-blue-900/30 px-3 py-2 text-sm text-blue-200 hover:bg-blue-900/40 disabled:opacity-50",onClick:()=>y.mutate(),disabled:y.isPending||b.isLoading,children:y.isPending?"Saving…":"Save setting"})]})]}),o.length===0?e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(u,{children:"No HMM-Local Stratum pool configured"})}),e.jsxs(h,{className:"space-y-3 text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Add or update a pool with driver ",e.jsx("span",{className:"font-semibold text-foreground",children:"hmm_local_stratum"})," to populate this page."]}),e.jsx("div",{children:e.jsx(I,{className:"text-blue-400 hover:text-blue-300 underline",to:"/pools",children:"Go to Pools"})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[e.jsxs(m,{children:[e.jsx(x,{className:"pb-2",children:e.jsx(u,{className:"text-sm text-muted-foreground",children:"Configured pools"})}),e.jsxs(h,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:o.length}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[f.unhealthyPools," degraded"]})]})]}),e.jsxs(m,{children:[e.jsx(x,{className:"pb-2",children:e.jsx(u,{className:"text-sm text-muted-foreground",children:"Data freshness risk"})}),e.jsxs(h,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:f.staleFeeds}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Stale feeds (> 3m old)"})]})]}),e.jsxs(m,{children:[e.jsx(x,{className:"pb-2",children:e.jsx(u,{className:"text-sm text-muted-foreground",children:"Driver warnings"})}),e.jsxs(h,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:f.driverWarnings}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Unresolved / not-loaded flags"})]})]}),e.jsxs(m,{children:[e.jsx(x,{className:"pb-2",children:e.jsx(u,{className:"text-sm text-muted-foreground",children:"Driver recoveries (24h)"})}),e.jsxs(h,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:f.recovered}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[f.unresolved," unresolved"]})]})]})]}),e.jsx("div",{className:"space-y-4",children:o.map(s=>{const c=Number.parseInt(s.pool_id,10),a=Number.isNaN(c)?void 0:w.get(c),j=A(s.last_updated),r=U(s.tile_3_shares.reject_rate);return e.jsxs(m,{children:[e.jsxs(x,{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx(u,{className:"text-lg",children:s.display_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/60 px-2 py-1 text-slate-300",children:[e.jsx($,{className:"h-3 w-3"})," Updated ",M(s.last_updated)]}),e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-1 ${j.className}`,children:["Feed ",j.label]}),s.tile_1_health.health_status?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-emerald-700/50 bg-emerald-900/30 px-2 py-1 text-emerald-300",children:[e.jsx(q,{className:"h-3 w-3"})," Healthy"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-amber-700/60 bg-amber-900/30 px-2 py-1 text-amber-300",children:[e.jsx(Q,{className:"h-3 w-3"})," Degraded"]})]})]}),(s.warnings||[]).length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:(s.warnings||[]).map(g=>e.jsx("span",{className:"inline-flex rounded-full border border-amber-700/60 bg-amber-900/30 px-2 py-1 text-xs text-amber-300",children:g},`${s.pool_id}-${g}`))})]}),e.jsxs(h,{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Service health"}),e.jsx("div",{className:"mt-1 text-sm text-slate-100",children:s.tile_1_health.health_message||"No message"}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Latency: ",s.tile_1_health.latency_ms??"N/A"," ms"]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Pipeline status"}),e.jsxs("div",{className:"mt-1 text-sm text-slate-100",children:["Last update: ",M(s.last_updated)]}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Workers online: ",s.tile_2_network.active_workers??"N/A"]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Feed state: ",j.label]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Quality / reliability"}),e.jsx("div",{className:"mt-1 flex items-center gap-2",children:e.jsxs("span",{className:`inline-flex rounded-full border px-2 py-1 text-xs ${r.className}`,children:["Reject risk: ",r.label]})}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Reject rate: ",W(s.tile_3_shares.reject_rate)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Valid ",s.tile_3_shares.shares_valid??"N/A"," · Invalid ",s.tile_3_shares.shares_invalid??"N/A"]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Driver recovery (24h)"}),e.jsxs("div",{className:"mt-1 text-sm text-slate-100",children:["Recovered: ",(a==null?void 0:a.recovered_count)||0]}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Unresolved: ",(a==null?void 0:a.unresolved_count)||0]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Last event: ",a!=null&&a.last_event_at?M(a.last_event_at):"None"]})]})]})]},s.pool_id)})})]})]})}export{G as default};
