import{m as se,r as p,a as F,n as B,j as e,C as h,f as o,A as V,V as z,B as _,Y as q,d as f,Z as ae,o as le,K,s as S,t as w,v as C,w as A,x as g,U as W}from"./index-fcxFM42K-1770643997960.js";import{R as $}from"./refresh-ccw-CFS4nAlS-1770643997960.js";import{I as re}from"./info-IuiFJ2eo-1770643997960.js";import{L as te}from"./layers-CRcAhzVf-1770643997960.js";const L={bitaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],nerdqaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],avalon_nano:[{value:"managed_externally",label:"HA Off / External"},{value:"low",label:"Low"},{value:"med",label:"Medium"},{value:"high",label:"High"}]};async function b(d,n){const m=await fetch(d,{headers:{"Content-Type":"application/json",...(n==null?void 0:n.headers)||{}},...n});if(!m.ok){const x=await m.json().catch(()=>({})),y=x.detail||x.message||`Request failed (${m.status})`;throw new Error(y)}if(m.status!==204)return m.json()}const ne=[{key:"bitaxe",label:"Bitaxe 601",icon:ae,helper:"Full control (eco/standard/turbo/oc)"},{key:"nerdqaxe",label:"NerdQaxe++",icon:z,helper:"Supports aggressive tuning profiles"},{key:"avalon_nano",label:"Avalon Nano 3/3S",icon:te,helper:"Uses low / med / high workmodes"},{key:"nmminer",label:"NMMiner ESP32",icon:le,helper:"Lottery miners for extreme variance plays"}];function ie(d){if(!d)return"Never";const n=new Date(d);return`${n.toLocaleDateString()} · ${n.toLocaleTimeString()}`}function de(d){return d==null?"—":`${d.toFixed(2)} p/kWh`}function he(){var U;const d=se(),[n,m]=p.useState(new Set),[x,y]=p.useState(!1),[N,H]=p.useState(!1),[k,u]=p.useState(null),{data:l,isLoading:J,error:E}=F({queryKey:["agile-strategy"],queryFn:()=>b("/api/settings/agile-solo-strategy")}),{data:M,isLoading:G,error:P}=F({queryKey:["agile-strategy-bands"],queryFn:()=>b("/api/settings/agile-solo-strategy/bands")}),{data:O,isLoading:Z}=F({queryKey:["pools-for-bands"],queryFn:()=>b("/api/pools/for-bands")});p.useEffect(()=>{l&&(y(l.enabled),H(l.champion_mode_enabled||!1),m(new Set(l.enrolled_miners.map(s=>s.id))))},[l]);const T=B({mutationFn:s=>b("/api/settings/agile-solo-strategy",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{u({type:"success",message:"Strategy settings saved"}),d.invalidateQueries({queryKey:["agile-strategy"]})},onError:s=>{u({type:"error",message:s.message})}}),I=B({mutationFn:({bandId:s,body:r})=>b(`/api/settings/agile-solo-strategy/bands/${s}`,{method:"PATCH",body:JSON.stringify(r)}),onSuccess:()=>{d.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),Q=B({mutationFn:()=>b("/api/settings/agile-solo-strategy/bands/reset",{method:"POST"}),onSuccess:()=>{u({type:"success",message:"Bands reset to defaults"}),d.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),j=p.useMemo(()=>({status:x?"Enabled":"Disabled",currentBand:(l==null?void 0:l.current_price_band)||"—",lastAction:ie((l==null?void 0:l.last_action_time)||null),currentPrice:de((l==null?void 0:l.last_price_checked)??null),enrolled:n.size,hysteresis:(l==null?void 0:l.hysteresis_counter)??0}),[l==null?void 0:l.current_price_band,l==null?void 0:l.hysteresis_counter,l==null?void 0:l.last_action_time,l==null?void 0:l.last_price_checked,n.size,x]),Y=s=>{m(r=>{const t=new Set(r);return t.has(s)?t.delete(s):t.add(s),t})},X=(s,r)=>{m(t=>{const i=new Set(t);return s.forEach(c=>{r?i.add(c):i.delete(c)}),i})},D=()=>{T.mutate({enabled:x,miner_ids:Array.from(n),champion_mode_enabled:N})},R=(s,r,t)=>{const i=t.trim(),c=i===""?null:Number(i);if(c!==null&&Number.isNaN(c)){u({type:"error",message:"Price thresholds must be numeric"});return}I.mutate({bandId:s,body:{[r]:c}})},v=(s,r,t)=>{I.mutate({bandId:s,body:{[r]:t}})};return J?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx($,{className:"h-6 w-6 animate-spin"}),e.jsx("p",{children:"Loading Agile Strategy…"})]})}):E?e.jsx("div",{className:"p-6",children:e.jsx(h,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(o,{className:"flex items-center gap-3 p-6 text-red-200",children:[e.jsx(V,{className:"h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Unable to load strategy settings"}),e.jsx("p",{className:"text-sm opacity-80",children:E instanceof Error?E.message:"Unknown error"})]})]})})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(z,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Strategy"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Octopus Agile Solo Strategy"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Enroll miners, map Octopus Agile price bands to mining targets, and let HMM orchestrate pool switching, tuning, and Home Assistant device control."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(_,{variant:x?"default":"outline",onClick:()=>y(s=>!s),className:"w-32",children:x?"Enabled":"Enable"}),e.jsx(_,{variant:"outline",disabled:T.isPending,onClick:D,children:"Save Settings"})]})]}),k&&e.jsx("div",{className:q("rounded-md border px-4 py-3 text-sm",k.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:k.message}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(h,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Status"}),e.jsx("p",{className:q("mt-2 text-xl font-semibold",x?"text-green-300":"text-gray-300"),children:j.status})]})}),e.jsx(h,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Band"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:j.currentBand})]})}),e.jsx(h,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Last Action"}),e.jsx("p",{className:"mt-2 text-sm text-gray-200",children:j.lastAction})]})}),e.jsx(h,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Enrolled Miners"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:j.enrolled})]})})]}),e.jsxs(h,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Strategy Primer"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Understand how pricing bands, solo vs pooled modes, and hysteresis interact before enabling automation."})]})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-blue-200",children:[e.jsx(re,{className:"h-4 w-4"})," What happens when prices spike?"]}),e.jsx("p",{className:"mt-2 text-blue-100/80",children:'When the OFF band threshold is reached the orchestration layer pauses miner tuning/pool changes and sends "off" commands to linked Home Assistant switches. As soon as prices settle into a cheaper band the strategy resumes normal operation.'})]}),e.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 text-sm text-amber-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-amber-200",children:[e.jsx(V,{className:"h-4 w-4"})," Avoid rule conflicts"]}),e.jsx("p",{className:"mt-2 text-amber-100/80",children:"Automation rules that touch enrolled miners (mode changes, pool overrides, HA commands) may conflict with the strategy engine. Disable conflicting rules or scope them to miners not enrolled here."})]})]})]}),e.jsxs(h,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enroll Miners"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Only enabled ASIC miners appear. Use group toggles to speed up selection."})]})}),e.jsx(o,{className:"space-y-6",children:ne.map(s=>{var c;const r=((c=l==null?void 0:l.miners_by_type)==null?void 0:c[s.key])??[],t=r.filter(a=>n.has(a.id)).length,i=r.length>0&&t===r.length;return e.jsxs("div",{className:"rounded-lg border border-gray-800 bg-gray-900/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(s.icon,{className:"h-4 w-4 text-blue-300"})," ",s.label]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.helper})]}),r.length>0&&e.jsxs(_,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>X(r.map(a=>a.id),!i),children:[i?"Clear":"Select all"," (",t,"/",r.length,")"]})]}),r.length===0?e.jsx("p",{className:"mt-4 rounded-md border border-dashed border-gray-700 p-3 text-sm text-gray-500",children:"No miners available."}):e.jsx("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:r.map(a=>e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border border-gray-800 bg-gray-950/60 p-3 hover:border-blue-500/40",children:[e.jsx(K,{checked:n.has(a.id),onCheckedChange:()=>Y(a.id)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-100",children:a.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID #",a.id]})]})]},a.id))})]},s.key)})})]}),e.jsxs(h,{children:[e.jsx(f,{children:e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Price Band Strategy"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Map Agile price windows to coins and tuning modes."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(_,{variant:"outline",size:"sm",disabled:Q.isPending,onClick:()=>Q.mutate(),className:"gap-2",children:[e.jsx($,{className:"h-4 w-4"})," Reset to defaults"]})})]})})}),e.jsx(o,{className:"space-y-4",children:e.jsx("div",{className:"rounded-lg border border-purple-500/30 bg-purple-500/5 p-4",children:e.jsxs("label",{className:"flex cursor-pointer items-start gap-3",children:[e.jsx(K,{checked:N,onCheckedChange:s=>H(!!s),className:"mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("p",{className:"font-semibold text-purple-200",children:"Enable Champion Mode for Band 5 (20-30 p/kWh)"})}),e.jsx("p",{className:"mt-1 text-sm text-purple-100/70",children:"Only the most efficient miner (by W/TH) runs in lowest mode during expensive periods. All other miners are turned OFF via Home Assistant. Champion is sticky until band exit. If champion fails, next best miner is promoted."}),N&&(l==null?void 0:l.current_champion_miner_id)&&e.jsxs("div",{className:"mt-3 rounded-md border border-purple-400/30 bg-purple-900/20 px-3 py-2",children:[e.jsx("p",{className:"text-xs uppercase text-purple-300",children:"Current Champion"}),e.jsx("p",{className:"mt-1 font-semibold text-purple-100",children:((U=l.enrolled_miners.find(s=>s.id===l.current_champion_miner_id))==null?void 0:U.name)||`Miner #${l.current_champion_miner_id}`})]})]})]})})}),e.jsx(f,{children:e.jsx("p",{className:"text-sm text-gray-400",children:"Configure price bands below. Band 5 uses champion mode when enabled."})}),e.jsx(o,{className:"overflow-x-auto",children:G?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading bands…"}):P?e.jsx("div",{className:"rounded-md border border-red-500/40 bg-red-500/10 p-4 text-sm text-red-200",children:P.message||"Failed to load price bands"}):e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Price band (p/kWh)"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Coin"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Bitaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"NerdQaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Avalon Nano Mode"}),e.jsx("th",{className:"py-3 font-medium",children:"Notes"})]})}),e.jsx("tbody",{children:M==null?void 0:M.bands.map(s=>{var c;const r=s.target_pool_id===null,i=s.sort_order===5&&N;return e.jsx(p.Fragment,{children:e.jsxs("tr",{className:q("border-t border-gray-800",i&&"bg-purple-500/5"),children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",defaultValue:s.min_price??"",placeholder:"min",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>R(s.id,"min_price",a.target.value)}),e.jsx("span",{className:"text-gray-500",children:"–"}),e.jsx("input",{type:"number",defaultValue:s.max_price??"",placeholder:"max",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>R(s.id,"max_price",a.target.value)})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{value:((c=s.target_pool_id)==null?void 0:c.toString())||"OFF",onValueChange:a=>{const ee=a==="OFF"?null:parseInt(a,10);v(s.id,"target_pool_id",ee)},children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Select pool"})}),e.jsxs(A,{children:[e.jsx(g,{value:"OFF",children:"OFF (devices off)"}),Z?e.jsx(g,{value:"loading",disabled:!0,children:"Loading pools..."}):O==null?void 0:O.map(a=>e.jsxs(g,{value:a.id.toString(),children:[a.name," · ",a.supported_coins.join(", ")]},a.id))]})]})}),i?e.jsx("td",{className:"py-3 pr-4",colSpan:3,children:e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-purple-500/40 bg-purple-900/20 px-3 py-2",children:[e.jsx(W,{className:"h-4 w-4 text-purple-300"}),e.jsx("span",{className:"text-sm font-semibold text-purple-200",children:"Champion Mode Enabled"}),e.jsx("span",{className:"text-xs text-purple-300/70",children:"(Most efficient miner in lowest mode)"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:r,value:s.bitaxe_mode,onValueChange:a=>v(s.id,"bitaxe_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Bitaxe mode"})}),e.jsx(A,{children:L.bitaxe.map(a=>e.jsx(g,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:r,value:s.nerdqaxe_mode,onValueChange:a=>v(s.id,"nerdqaxe_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"NerdQaxe mode"})}),e.jsx(A,{children:L.nerdqaxe.map(a=>e.jsx(g,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:r,value:s.avalon_nano_mode,onValueChange:a=>v(s.id,"avalon_nano_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Avalon mode"})}),e.jsx(A,{children:L.avalon_nano.map(a=>e.jsx(g,{value:a.value,children:a.label},a.value))})]})})]}),e.jsx("td",{className:"py-3 text-gray-500",children:r?"Turns off all linked HA devices":i?"Champion promoted on band entry, sticky until exit":"Applies pool + mode changes (or HA off if selected)"})]})},s.id)})})]})})]}),e.jsxs(h,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(W,{className:"h-5 w-5 text-green-300"})," Hysteresis & Recovery"]})}),e.jsx(o,{children:e.jsxs("ul",{className:"list-disc space-y-2 pl-5 text-sm text-gray-300",children:[e.jsx("li",{children:"Upgrades into cheaper bands require the next 30-minute slot to confirm the same or better price."}),e.jsx("li",{children:"Downgrades into expensive bands happen immediately to avoid negative profitability."}),e.jsx("li",{children:"The scheduler executes every 30 minutes plus an additional reconciliation run when prices change suddenly."}),e.jsxs("li",{children:["Current hysteresis counter: ",e.jsx("span",{className:"font-semibold text-white",children:j.hysteresis})]})]})})]})]})}export{he as default};
