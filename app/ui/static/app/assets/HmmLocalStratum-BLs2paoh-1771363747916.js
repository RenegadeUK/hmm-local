import{m as J,r as b,a as M,n as X,j as e,o as Z,W as P,C as _,d as f,e as j,f as v,L as H,R as ee,a1 as A,a2 as G}from"./index-DH1tuhK--1771363747916.js";import{C as se}from"./check-circle-2-B35NMLt6-1771363747916.js";import{A as te}from"./alert-triangle-ClaxKYpI-1771363747916.js";const ae="hmm_local_stratum";function re(a){return typeof a!="number"||!Number.isFinite(a)?"N/A":`${a.toFixed(2)}%`}function r(a){return typeof a!="number"||!Number.isFinite(a)?"N/A":new Intl.NumberFormat().format(a)}function le(a){return typeof a!="number"||!Number.isFinite(a)?"N/A":a>=1024?`${(a/1024).toFixed(2)} GB`:`${a.toFixed(1)} MB`}function V(a){if(!a)return{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"};const h=new Date(a).getTime();if(Number.isNaN(h))return{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"};const u=Math.max(0,Math.floor((Date.now()-h)/1e3));return u<=60?{label:"Fresh",className:"border-emerald-700/50 bg-emerald-900/30 text-emerald-300"}:u<=180?{label:"Aging",className:"border-amber-700/60 bg-amber-900/30 text-amber-300"}:{label:"Stale",className:"border-red-700/60 bg-red-900/30 text-red-300"}}function ne(a){return typeof a!="number"||!Number.isFinite(a)?{label:"Unknown",className:"border-slate-700/50 bg-slate-900/30 text-slate-300"}:a>=5?{label:"High",className:"border-red-700/60 bg-red-900/30 text-red-300"}:a>=3?{label:"Elevated",className:"border-amber-700/60 bg-amber-900/30 text-amber-300"}:{label:"Normal",className:"border-emerald-700/50 bg-emerald-900/30 text-emerald-300"}}function L(a){if(!a)return"Unknown";const h=new Date(a).getTime();if(Number.isNaN(h))return a;const u=Math.max(0,Math.floor((Date.now()-h)/1e3));if(u<60)return`${u}s ago`;const p=Math.floor(u/60);if(p<60)return`${p}m ago`;const g=Math.floor(p/60);return g<24?`${g}h ago`:`${Math.floor(g/24)}d ago`}function oe(){var D,T,I;const a=J(),[h,u]=b.useState(!1),[p,g]=b.useState(null),y=M({queryKey:["integrations","hmm-local-stratum","settings"],queryFn:()=>A.getHmmLocalStratumSettings(),staleTime:3e4});b.useEffect(()=>{var t;typeof((t=y.data)==null?void 0:t.enabled)=="boolean"&&u(y.data.enabled)},[(D=y.data)==null?void 0:D.enabled]);const k=X({mutationFn:()=>A.saveHmmLocalStratumSettings(h),onSuccess:t=>{g({tone:"success",message:t.message||"Settings saved"}),a.invalidateQueries({queryKey:["integrations","hmm-local-stratum","settings"]}),a.invalidateQueries({queryKey:["layout","stratum-dashboards-enabled"]}),setTimeout(()=>g(null),3500)},onError:t=>{g({tone:"error",message:t.message||"Failed to save settings"}),setTimeout(()=>g(null),3500)}}),S=M({queryKey:["integrations","hmm-local-stratum","tiles"],queryFn:()=>G.getPoolTiles(),refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),C=M({queryKey:["integrations","hmm-local-stratum","recovery-status"],queryFn:()=>G.getRecoveryStatus(24),refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),F=M({queryKey:["integrations","hmm-local-stratum","operational"],queryFn:()=>A.getHmmLocalStratumOperational(),refetchInterval:3e4,refetchOnWindowFocus:!1,staleTime:25e3}),N=b.useMemo(()=>Object.values(S.data||{}).filter(t=>t.pool_type===ae),[S.data]),q=b.useMemo(()=>{var m;const t=new Map;for(const i of((m=C.data)==null?void 0:m.pools)||[])t.set(i.pool_id,i);return t},[(T=C.data)==null?void 0:T.pools]),Y=b.useMemo(()=>{var m,i;const t=new Map;for(const n of((m=F.data)==null?void 0:m.pools)||[])typeof((i=n.pool)==null?void 0:i.id)=="number"&&t.set(n.pool.id,n);return t},[(I=F.data)==null?void 0:I.pools]),w=b.useMemo(()=>{const t=N.filter(s=>s.tile_1_health.health_status===!1).length,m=N.reduce((s,l)=>{const d=Number.parseInt(l.pool_id,10),c=Number.isNaN(d)?void 0:q.get(d);return s.recovered+=(c==null?void 0:c.recovered_count)||0,s.unresolved+=(c==null?void 0:c.unresolved_count)||0,s},{recovered:0,unresolved:0}),i=N.filter(s=>V(s.last_updated).label==="Stale").length,n=N.reduce((s,l)=>{var d;return s+(((d=l.warnings)==null?void 0:d.length)||0)},0);return{unhealthyPools:t,staleFeeds:i,driverWarnings:n,recovered:m.recovered,unresolved:m.unresolved}},[q,N]);return S.isLoading?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin text-blue-500"})}):S.isError?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(P,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"HMM-Local Stratum"})]}),e.jsx("div",{className:"rounded-lg border border-red-700 bg-red-900/30 p-4 text-red-200",children:"Failed to load Stratum operational data."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(P,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"HMM-Local Stratum"})]}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Dedicated operational status view for local Stratum integration pools."})]}),p&&e.jsx("div",{className:`rounded-lg border px-4 py-3 text-sm ${p.tone==="success"?"border-emerald-700/60 bg-emerald-900/30 text-emerald-200":p.tone==="error"?"border-red-700/60 bg-red-900/30 text-red-200":"border-blue-700/60 bg-blue-900/30 text-blue-200"}`,children:p.message}),e.jsxs(_,{children:[e.jsx(f,{children:e.jsx(j,{children:"HMM-Local Stratum dashboards"})}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-start gap-3 rounded-lg border border-slate-700/50 bg-slate-900/30 p-3",children:[e.jsx("input",{type:"checkbox",className:"mt-0.5 h-4 w-4",checked:h,onChange:t=>u(t.target.checked),disabled:y.isLoading||k.isPending}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-slate-100",children:"Enable dedicated HMM-Local Stratum dashboards"}),e.jsx("div",{className:"text-xs text-slate-400",children:"When enabled, a new top-level navigation section appears with BTC, BCH and DGB pages focused on mining pool data."})]})]}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-md border border-blue-700/60 bg-blue-900/30 px-3 py-2 text-sm text-blue-200 hover:bg-blue-900/40 disabled:opacity-50",onClick:()=>k.mutate(),disabled:k.isPending||y.isLoading,children:k.isPending?"Saving…":"Save setting"})]})]}),N.length===0?e.jsxs(_,{children:[e.jsx(f,{children:e.jsx(j,{children:"No HMM-Local Stratum pool configured"})}),e.jsxs(v,{className:"space-y-3 text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Add or update a pool with driver ",e.jsx("span",{className:"font-semibold text-foreground",children:"hmm_local_stratum"})," to populate this page."]}),e.jsx("div",{children:e.jsx(H,{className:"text-blue-400 hover:text-blue-300 underline",to:"/pools",children:"Go to Pools"})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[e.jsxs(_,{children:[e.jsx(f,{className:"pb-2",children:e.jsx(j,{className:"text-sm text-muted-foreground",children:"Configured pools"})}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:N.length}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[w.unhealthyPools," degraded"]})]})]}),e.jsxs(_,{children:[e.jsx(f,{className:"pb-2",children:e.jsx(j,{className:"text-sm text-muted-foreground",children:"Data freshness risk"})}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:w.staleFeeds}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Stale feeds (> 3m old)"})]})]}),e.jsxs(_,{children:[e.jsx(f,{className:"pb-2",children:e.jsx(j,{className:"text-sm text-muted-foreground",children:"Driver warnings"})}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:w.driverWarnings}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Unresolved / not-loaded flags"})]})]}),e.jsxs(_,{children:[e.jsx(f,{className:"pb-2",children:e.jsx(j,{className:"text-sm text-muted-foreground",children:"Driver recoveries (24h)"})}),e.jsxs(v,{children:[e.jsx("div",{className:"text-3xl font-semibold",children:w.recovered}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[w.unresolved," unresolved"]})]})]})]}),e.jsx("div",{className:"space-y-4",children:N.map(t=>{var E,Q,U,W,O,K,B;const m=Number.parseInt(t.pool_id,10),i=Number.isNaN(m)?void 0:q.get(m),n=Number.isNaN(m)?void 0:Y.get(m),s=(E=n==null?void 0:n.stats)==null?void 0:E.datastore,l=n==null?void 0:n.database,d=l==null?void 0:l.pool,c=l==null?void 0:l.postgresql,o=(Q=l==null?void 0:l.high_water_marks)==null?void 0:Q.last_24h,x=(U=l==null?void 0:l.high_water_marks)==null?void 0:U.since_boot,R=V(t.last_updated),$=ne(t.tile_3_shares.reject_rate);return e.jsxs(_,{children:[e.jsxs(f,{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx(j,{className:"text-lg",children:t.display_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/60 px-2 py-1 text-slate-300",children:[e.jsx(ee,{className:"h-3 w-3"})," Updated ",L(t.last_updated)]}),e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-1 ${R.className}`,children:["Feed ",R.label]}),t.tile_1_health.health_status?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-emerald-700/50 bg-emerald-900/30 px-2 py-1 text-emerald-300",children:[e.jsx(se,{className:"h-3 w-3"})," Healthy"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-amber-700/60 bg-amber-900/30 px-2 py-1 text-amber-300",children:[e.jsx(te,{className:"h-3 w-3"})," Degraded"]})]})]}),(t.warnings||[]).length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:(t.warnings||[]).map(z=>e.jsx("span",{className:"inline-flex rounded-full border border-amber-700/60 bg-amber-900/30 px-2 py-1 text-xs text-amber-300",children:z},`${t.pool_id}-${z}`))})]}),e.jsxs(v,{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Service health"}),e.jsx("div",{className:"mt-1 text-sm text-slate-100",children:t.tile_1_health.health_message||"No message"}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Latency: ",t.tile_1_health.latency_ms??"N/A"," ms"]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Operational info (/stats)"}),F.isLoading?e.jsx("div",{className:"mt-1 text-sm text-slate-300",children:"Loading operational stats…"}):(n==null?void 0:n.status)!=="ok"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-1 text-sm text-amber-300",children:"Unavailable"}),e.jsx("div",{className:"mt-1 text-xs text-slate-400",children:(n==null?void 0:n.error)||"No response from Stratum API"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-sm text-slate-100",children:["Queue: ",r(s==null?void 0:s.queue_depth)," / max seen ",r(s==null?void 0:s.max_queue_depth_seen)]}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Rows written: ",r(s==null?void 0:s.total_rows_written)," · Dropped: ",r(s==null?void 0:s.total_dropped)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Batches ok/fail: ",r(s==null?void 0:s.total_write_batches_ok)," / ",r(s==null?void 0:s.total_write_batches_failed)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Enqueued: ",r(s==null?void 0:s.total_enqueued)," · Spooled/Replayed: ",r(s==null?void 0:s.total_spooled_rows)," / ",r(s==null?void 0:s.total_replayed_rows)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Retries: ",r(s==null?void 0:s.total_retries)," · Consecutive failures: ",r(s==null?void 0:s.consecutive_write_failures)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Last write: ",L((s==null?void 0:s.last_write_ok_at)||null)," · Latency: ",((W=s==null?void 0:s.last_write_latency_ms)==null?void 0:W.toFixed(2))??"N/A"," ms"]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["DB: ",(O=n.stats)!=null&&O.db_enabled?"enabled":"disabled"," · Datastore: ",s!=null&&s.enabled?"enabled":"disabled"]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Retention (d): H ",r(s==null?void 0:s.hashrate_retention_days)," · N ",r(s==null?void 0:s.network_retention_days)," · K ",r(s==null?void 0:s.kpi_retention_days)]}),(s==null?void 0:s.spool_path)&&e.jsxs("div",{className:"truncate text-xs text-slate-500",title:s.spool_path,children:["Spool path: ",s.spool_path]}),e.jsx("div",{className:"mt-2 border-t border-slate-700/60 pt-2 text-xs uppercase tracking-wide text-slate-400",children:"Stratum DB health"}),n.database_status!=="ok"?e.jsxs("div",{className:"text-xs text-amber-300",children:["Unavailable: ",n.database_error||"No DB health response"]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-400",children:["Connection pool: ",r(d==null?void 0:d.checked_out)," / ",r((d==null?void 0:d.max_capacity_configured)??(d==null?void 0:d.total_capacity))," (",((K=d==null?void 0:d.utilization_percent)==null?void 0:K.toFixed(1))??"N/A","% utilized)"]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Active queries: ",r(c==null?void 0:c.active_connections)," · DB size: ",le(c==null?void 0:c.database_size_mb)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Health status: ",((l==null?void 0:l.status)||"unknown").toUpperCase()," · Slow queries: ",r(c==null?void 0:c.long_running_queries)]}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["24h HWM (since ",((B=l==null?void 0:l.high_water_marks)==null?void 0:B.last_24h_date)||"N/A","): pool peak ",r(o==null?void 0:o.db_pool_in_use_peak),", active peak ",r(o==null?void 0:o.active_queries_peak),", waits ",r(o==null?void 0:o.db_pool_wait_count)," (",(o==null?void 0:o.db_pool_wait_seconds_sum)??"N/A","s), slow ",r(o==null?void 0:o.slow_queries_peak)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Boot HWM: pool peak ",r(x==null?void 0:x.db_pool_in_use_peak),", active peak ",r(x==null?void 0:x.active_queries_peak),", waits ",r(x==null?void 0:x.db_pool_wait_count)," (",(x==null?void 0:x.db_pool_wait_seconds_sum)??"N/A","s), slow ",r(x==null?void 0:x.slow_queries_peak)]})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Quality / reliability"}),e.jsx("div",{className:"mt-1 flex items-center gap-2",children:e.jsxs("span",{className:`inline-flex rounded-full border px-2 py-1 text-xs ${$.className}`,children:["Reject risk: ",$.label]})}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Reject rate: ",re(t.tile_3_shares.reject_rate)]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Valid ",t.tile_3_shares.shares_valid??"N/A"," · Invalid ",t.tile_3_shares.shares_invalid??"N/A"]})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700/60 bg-slate-900/40 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Driver recovery (24h)"}),e.jsxs("div",{className:"mt-1 text-sm text-slate-100",children:["Recovered: ",(i==null?void 0:i.recovered_count)||0]}),e.jsxs("div",{className:"mt-1 text-xs text-slate-400",children:["Unresolved: ",(i==null?void 0:i.unresolved_count)||0]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Last event: ",i!=null&&i.last_event_at?L(i.last_event_at):"None"]})]})]})]},t.pool_id)})})]})]})}export{oe as default};
