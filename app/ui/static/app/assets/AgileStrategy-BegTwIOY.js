import{l as G,r as p,a as H,j as e,C as x,f as h,A as L,Q as R,B as f,U as Q,d as N,Z as W,m as J,I as Z,o as v,p as S,q as w,s as C,t as _,O as X}from"./index-yUG4AcLO.js";import{u as O}from"./useMutation-xu2DnCOU.js";import{R as I}from"./refresh-ccw-Cg6LqJ-2.js";import{I as Y}from"./info-B21rwgVY.js";import{L as D}from"./layers-C4sm1Cyy.js";const ee=[{value:"OFF",label:"OFF (devices off)"},{value:"DGB",label:"DGB · DigiByte Solo"},{value:"BC2",label:"BC2 · DigiByte Turbo"},{value:"BCH",label:"BCH · Bitcoin Cash Solo"},{value:"BTC",label:"BTC · Bitcoin Solo"},{value:"BTC_POOLED",label:"BTC · Braiins Pool"}],k={bitaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],nerdqaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],avalon_nano:[{value:"managed_externally",label:"HA Off / External"},{value:"low",label:"Low"},{value:"med",label:"Medium"},{value:"high",label:"High"}]};async function b(n,r){const i=await fetch(n,{headers:{"Content-Type":"application/json",...(r==null?void 0:r.headers)||{}},...r});if(!i.ok){const d=await i.json().catch(()=>({})),j=d.detail||d.message||`Request failed (${i.status})`;throw new Error(j)}if(i.status!==204)return i.json()}const se=[{key:"bitaxe",label:"Bitaxe 601",icon:W,helper:"Full control (eco/standard/turbo/oc)"},{key:"nerdqaxe",label:"NerdQaxe++",icon:R,helper:"Supports aggressive tuning profiles"},{key:"avalon_nano",label:"Avalon Nano 3/3S",icon:D,helper:"Uses low / med / high workmodes"},{key:"nmminer",label:"NMMiner ESP32",icon:J,helper:"Lottery miners for extreme variance plays"}];function ae(n){if(!n)return"Never";const r=new Date(n);return`${r.toLocaleDateString()} · ${r.toLocaleTimeString()}`}function le(n){return n==null?"—":`${n.toFixed(2)} p/kWh`}function ce(){const n=G(),[r,i]=p.useState(new Set),[d,j]=p.useState(!1),[B,u]=p.useState(null),{data:l,isLoading:U,error:A}=H({queryKey:["agile-strategy"],queryFn:()=>b("/api/settings/agile-solo-strategy")}),{data:E,isLoading:V,error:M}=H({queryKey:["agile-strategy-bands"],queryFn:()=>b("/api/settings/agile-solo-strategy/bands")});p.useEffect(()=>{l&&(j(l.enabled),i(new Set(l.enrolled_miners.map(s=>s.id))))},[l]);const T=O({mutationFn:s=>b("/api/settings/agile-solo-strategy",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{u({type:"success",message:"Strategy settings saved"}),n.invalidateQueries({queryKey:["agile-strategy"]})},onError:s=>{u({type:"error",message:s.message})}}),F=O({mutationFn:({bandId:s,body:t})=>b(`/api/settings/agile-solo-strategy/bands/${s}`,{method:"PATCH",body:JSON.stringify(t)}),onSuccess:()=>{n.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),P=O({mutationFn:()=>b("/api/settings/agile-solo-strategy/bands/reset",{method:"POST"}),onSuccess:()=>{u({type:"success",message:"Bands reset to defaults"}),n.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{u({type:"error",message:s.message})}}),g=p.useMemo(()=>({status:d?"Enabled":"Disabled",currentBand:(l==null?void 0:l.current_price_band)||"—",lastAction:ae((l==null?void 0:l.last_action_time)||null),currentPrice:le((l==null?void 0:l.last_price_checked)??null),enrolled:r.size,hysteresis:(l==null?void 0:l.hysteresis_counter)??0}),[l==null?void 0:l.current_price_band,l==null?void 0:l.hysteresis_counter,l==null?void 0:l.last_action_time,l==null?void 0:l.last_price_checked,r.size,d]),K=s=>{i(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})},$=(s,t)=>{i(a=>{const c=new Set(a);return s.forEach(o=>{t?c.add(o):c.delete(o)}),c})},z=()=>{T.mutate({enabled:d,miner_ids:Array.from(r)})},q=(s,t,a)=>{const c=a.trim(),o=c===""?null:Number(c);if(o!==null&&Number.isNaN(o)){u({type:"error",message:"Price thresholds must be numeric"});return}F.mutate({bandId:s,body:{[t]:o}})},y=(s,t,a)=>{F.mutate({bandId:s,body:{[t]:a}})};return U?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(I,{className:"h-6 w-6 animate-spin"}),e.jsx("p",{children:"Loading Agile Strategy…"})]})}):A?e.jsx("div",{className:"p-6",children:e.jsx(x,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(h,{className:"flex items-center gap-3 p-6 text-red-200",children:[e.jsx(L,{className:"h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Unable to load strategy settings"}),e.jsx("p",{className:"text-sm opacity-80",children:A instanceof Error?A.message:"Unknown error"})]})]})})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(R,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Strategy"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Octopus Agile Solo Strategy"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Enroll miners, map Octopus Agile price bands to mining targets, and let HMM orchestrate pool switching, tuning, and Home Assistant device control."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(f,{variant:d?"default":"outline",onClick:()=>j(s=>!s),className:"w-32",children:d?"Enabled":"Enable"}),e.jsx(f,{variant:"outline",disabled:T.isPending,onClick:z,children:"Save Settings"})]})]}),B&&e.jsx("div",{className:Q("rounded-md border px-4 py-3 text-sm",B.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:B.message}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(x,{children:e.jsxs(h,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Status"}),e.jsx("p",{className:Q("mt-2 text-xl font-semibold",d?"text-green-300":"text-gray-300"),children:g.status})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Band"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:g.currentBand})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Last Action"}),e.jsx("p",{className:"mt-2 text-sm text-gray-200",children:g.lastAction})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Enrolled Miners"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:g.enrolled})]})})]}),e.jsxs(x,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Strategy Primer"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Understand how pricing bands, solo vs pooled modes, and hysteresis interact before enabling automation."})]})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-blue-200",children:[e.jsx(Y,{className:"h-4 w-4"})," What happens when prices spike?"]}),e.jsx("p",{className:"mt-2 text-blue-100/80",children:'When the OFF band threshold is reached the orchestration layer pauses miner tuning/pool changes and sends "off" commands to linked Home Assistant switches. As soon as prices settle into a cheaper band the strategy resumes normal operation.'})]}),e.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 text-sm text-amber-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-amber-200",children:[e.jsx(L,{className:"h-4 w-4"})," Avoid rule conflicts"]}),e.jsx("p",{className:"mt-2 text-amber-100/80",children:"Automation rules that touch enrolled miners (mode changes, pool overrides, HA commands) may conflict with the strategy engine. Disable conflicting rules or scope them to miners not enrolled here."})]})]})]}),e.jsxs(x,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enroll Miners"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Only enabled ASIC miners appear. Use group toggles to speed up selection."})]})}),e.jsx(h,{className:"space-y-6",children:se.map(s=>{var o;const t=((o=l==null?void 0:l.miners_by_type)==null?void 0:o[s.key])??[],a=t.filter(m=>r.has(m.id)).length,c=t.length>0&&a===t.length;return e.jsxs("div",{className:"rounded-lg border border-gray-800 bg-gray-900/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(s.icon,{className:"h-4 w-4 text-blue-300"})," ",s.label]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.helper})]}),t.length>0&&e.jsxs(f,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>$(t.map(m=>m.id),!c),children:[c?"Clear":"Select all"," (",a,"/",t.length,")"]})]}),t.length===0?e.jsx("p",{className:"mt-4 rounded-md border border-dashed border-gray-700 p-3 text-sm text-gray-500",children:"No miners available."}):e.jsx("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:t.map(m=>e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border border-gray-800 bg-gray-950/60 p-3 hover:border-blue-500/40",children:[e.jsx(Z,{checked:r.has(m.id),onCheckedChange:()=>K(m.id)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-100",children:m.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID #",m.id]})]})]},m.id))})]},s.key)})})]}),e.jsxs(x,{children:[e.jsx(N,{children:e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Price Band Strategy"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Map Agile price windows to coins and tuning modes."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(f,{variant:"outline",size:"sm",disabled:P.isPending,onClick:()=>P.mutate(),className:"gap-2",children:[e.jsx(I,{className:"h-4 w-4"})," Reset to defaults"]})})]})})}),e.jsx(h,{className:"overflow-x-auto",children:V?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading bands…"}):M?e.jsx("div",{className:"rounded-md border border-red-500/40 bg-red-500/10 p-4 text-sm text-red-200",children:M.message||"Failed to load price bands"}):e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Price band (p/kWh)"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Coin"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Bitaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"NerdQaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Avalon Nano Mode"}),e.jsx("th",{className:"py-3 font-medium",children:"Notes"})]})}),e.jsx("tbody",{children:E==null?void 0:E.bands.map(s=>{const t=s.target_coin==="OFF";return e.jsx(p.Fragment,{children:e.jsxs("tr",{className:"border-t border-gray-800",children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",defaultValue:s.min_price??"",placeholder:"min",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>q(s.id,"min_price",a.target.value)}),e.jsx("span",{className:"text-gray-500",children:"–"}),e.jsx("input",{type:"number",defaultValue:s.max_price??"",placeholder:"max",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>q(s.id,"max_price",a.target.value)})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(v,{value:s.target_coin,onValueChange:a=>y(s.id,"target_coin",a),children:[e.jsx(S,{children:e.jsx(w,{placeholder:"Select coin"})}),e.jsx(C,{children:ee.map(a=>e.jsx(_,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(v,{disabled:t,value:s.bitaxe_mode,onValueChange:a=>y(s.id,"bitaxe_mode",a),children:[e.jsx(S,{children:e.jsx(w,{placeholder:"Bitaxe mode"})}),e.jsx(C,{children:k.bitaxe.map(a=>e.jsx(_,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(v,{disabled:t,value:s.nerdqaxe_mode,onValueChange:a=>y(s.id,"nerdqaxe_mode",a),children:[e.jsx(S,{children:e.jsx(w,{placeholder:"NerdQaxe mode"})}),e.jsx(C,{children:k.nerdqaxe.map(a=>e.jsx(_,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(v,{disabled:t,value:s.avalon_nano_mode,onValueChange:a=>y(s.id,"avalon_nano_mode",a),children:[e.jsx(S,{children:e.jsx(w,{placeholder:"Avalon mode"})}),e.jsx(C,{children:k.avalon_nano.map(a=>e.jsx(_,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 text-gray-500",children:t?"Turns off all linked HA devices":"Applies pool + mode changes (or HA off if selected)"})]})},s.id)})})]})})]}),e.jsxs(x,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(X,{className:"h-5 w-5 text-green-300"})," Hysteresis & Recovery"]})}),e.jsx(h,{children:e.jsxs("ul",{className:"list-disc space-y-2 pl-5 text-sm text-gray-300",children:[e.jsx("li",{children:"Upgrades into cheaper bands require the next 30-minute slot to confirm the same or better price."}),e.jsx("li",{children:"Downgrades into expensive bands happen immediately to avoid negative profitability."}),e.jsx("li",{children:"The scheduler executes every 30 minutes plus an additional reconciliation run when prices change suddenly."}),e.jsxs("li",{children:["Current hysteresis counter: ",e.jsx("span",{className:"font-semibold text-white",children:g.hysteresis})]})]})})]})]})}export{ce as default};
