services:
  updater:
    build:
      context: ./updater
    container_name: hmm-local-updater
    ports:
      - "8081:8081"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AUTO_DEPLOY_ENABLED=${AUTO_DEPLOY_ENABLED:-false}  # Set to 'true' to enable automatic updates from GitHub Actions
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  stratum:
    build:
      context: ./stratum
    container_name: hmm-local-stratum
    ports:
      - "3333:3333"  # BTC stratum
      - "3334:3334"  # BCH stratum
      - "3335:3335"  # DGB stratum (SHA256d only)
      - "8082:8082"  # Stratum stats API
    volumes:
      - ./config:/config
    environment:
      - STRATUM_BIND_HOST=0.0.0.0
      - DGB_ALGO=sha256d
      - BTC_RPC_URL=${BTC_RPC_URL:-http://host.docker.internal:8332}
      - BCH_RPC_URL=${BCH_RPC_URL:-http://host.docker.internal:8333}
      - DGB_RPC_URL=${DGB_RPC_URL:-http://host.docker.internal:14022}
      - BTC_RPC_USER=${BTC_RPC_USER:-}
      - BCH_RPC_USER=${BCH_RPC_USER:-}
      - DGB_RPC_USER=${DGB_RPC_USER:-}
      - BTC_RPC_PASSWORD=${BTC_RPC_PASSWORD:-}
      - BCH_RPC_PASSWORD=${BCH_RPC_PASSWORD:-}
      - DGB_RPC_PASSWORD=${DGB_RPC_PASSWORD:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  miner-controller:
    # image: ghcr.io/renegadeuk/home_miner_manager:latest
    build:
      context: .
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    container_name: v0-miner-controller
    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
      - "12345:12345/udp"  # NMMiner telemetry broadcasts
      - "12347:12347/udp"  # NMMiner config
    volumes:
      - ./config:/config
      - /var/run/docker.sock:/var/run/docker.sock  # For container info detection
    environment:
      - WEB_PORT=${WEB_PORT:-8080}
      - TZ=${TZ:-UTC}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-hmm_secure_password_change_me}
      - UPDATER_URL=http://updater:8081
      - CONTAINER_NAME=v0-miner-controller
    restart: unless-stopped
    depends_on:
      - updater
      - stratum
