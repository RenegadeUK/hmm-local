services:
  updater:
    build:
      context: ./updater
    container_name: hmm-local-updater
    ports:
      - "8081:8081"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  miner-controller:
    # image: ghcr.io/renegadeuk/home_miner_manager:latest
    build:
      context: .
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    container_name: v0-miner-controller
    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
      - "12345:12345/udp"  # NMMiner telemetry broadcasts
      - "12347:12347/udp"  # NMMiner config
    volumes:
      - ./config:/config
    environment:
      - WEB_PORT=${WEB_PORT:-8080}
      - TZ=${TZ:-UTC}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-hmm_secure_password_change_me}
      - UPDATER_URL=http://updater:8081
    restart: unless-stopped
    depends_on:
      - updater
