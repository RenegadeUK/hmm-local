# DGB Local Stack (Scaffold)

Single container scaffold for:
- `digibyted` (pruned node)
- `ckpool` (DGB `sha256d`)
- Manager UI/API (FastAPI)

This is an initial foundation to iterate from. It bootstraps config layout and gives a simple control UI.

## Persistent storage layout

All data is under `/config`:

- `/config/node`
- `/config/ckpool`
- `/config/ui`
- `/config/logs/node`
- `/config/logs/ckpool`
- `/config/logs/ui`
- `/config/backups`

## Run

```bash
docker compose -f dgb-stack/docker-compose.yml up -d --build
```

Open manager UI:

- `http://localhost:8085`

## Image Publishing

Independent CI publishes this component as:

- `ghcr.io/<owner>/hmm-local-dgb-stack`

Typical tags generated by workflow metadata include:

- Branch tags (for example `main`)
- PR tags (for example `pr-123`)
- SHA tags (for example `main-<sha>`)
- Semver tags when release tags are used (for example `1.2.3`)

Pull examples:

```bash
# Latest branch build
docker pull ghcr.io/renegadeuk/hmm-local-dgb-stack:main

# Specific commit build
docker pull ghcr.io/renegadeuk/hmm-local-dgb-stack:main-<sha>

# Release tag build
docker pull ghcr.io/renegadeuk/hmm-local-dgb-stack:1.2.3
```

Run example:

```bash
docker run -d \
	--name dgb-local-stack \
	-p 8085:8085 \
	-p 3335:3335 \
	-v ./config:/config \
	ghcr.io/renegadeuk/hmm-local-dgb-stack:main
```

Compose image override example:

```yaml
services:
	dgb-local-stack:
		image: ghcr.io/renegadeuk/hmm-local-dgb-stack:main
		container_name: dgb-local-stack
		restart: unless-stopped
		ports:
			- "8085:8085"
			- "3335:3335"
		volumes:
			- ./config:/config
```

Compose override with immutable tag (recommended for production):

```yaml
services:
	dgb-local-stack:
		image: ghcr.io/renegadeuk/hmm-local-dgb-stack:main-<sha>
```

## Notes

- Coin is fixed to `DGB`.
- Algorithm is fixed to `sha256d`.
- Default stratum port is `3335`.
- Node defaults to pruned mode (`prune=550`).
- Default `ckpool.conf` is seeded with placeholder upstream/address values and must be edited.
- `ckpool` stays running in a wait state until placeholders are replaced, then can be restarted from the manager API.
- `digibyted` and `digibyte-cli` are copied from `moonkyu23403/digibyte:latest`.
- `ckpool` binaries are cloned and built during the image build.

## API

- `GET /health`
- `GET /api/status`
- `GET /api/config`
- `POST /api/config`
- `POST /api/restart/{service_name}`

## Integration API (`v1`)

- `GET /api/v1/capabilities`
- `GET /api/v1/services`
- `GET /api/v1/node/blockchain`
- `GET /api/v1/node/network`
- `GET /api/v1/node/mining`
- `GET /api/v1/ready`
- `GET /api/v1/ckpool/config`
- `GET /api/v1/ckpool/logs?lines=120`
- `GET /api/v1/ckpool/metrics`
- `GET /api/v1/events?since=2026-02-20T23:00:00&limit=200&order=asc&severity=error&event_type=system&source_contains=stderr`
- `GET /api/v1/events/cursor?since=2026-02-20T23:00:00&limit=200&order=asc&severity=error&event_type=system&source_contains=stderr`
- `GET /api/v1/snapshot?since=2026-02-20T23:00:00&limit=100`
- `GET /api/v1/snapshot/compact?since=2026-02-20T23:00:00&limit=200`